# 微信支付V3 API重构 - 实施计划

## 任务概览

| 任务ID | 任务名称 | 预估时间 | 依赖 | 状态 |
|--------|----------|----------|------|------|
| T1 | 创建配置管理模块 | 10min | - | ✅ 已完成 |
| T2 | 创建微信支付V3工具类 | 20min | T1 | ✅ 已完成 |
| T3 | 重写wxpay_order下单接口 | 20min | T2 | ✅ 已完成 |
| T4 | 重写wxpay_query查询接口 | 15min | T2 | ✅ 已完成 |
| T5 | 修改wxpayOrderCallback回调处理 | 15min | - | ✅ 已完成 |
| T6 | 更新package.json依赖 | 5min | - | ✅ 已完成 |
| T7 | 配置云函数环境变量 | 10min | T1-T6 | ✅ 已完成 |
| T8 | 部署云函数 | 10min | T7 | ✅ 已完成 |
| T9 | 测试验收 | 30min | T8 | ✅ 已完成 |

**总预估时间**: 约 2.5 小时

---

## 详细任务

### T1: 创建配置管理模块

- [x] 1.1 在 `wxpayFunctions/config/` 目录下创建 `index.js`
- [x] 1.2 定义配置项：appid、mchid、privateKey、serialNo、apiV3Key
- [x] 1.3 所有敏感配置从环境变量读取
- [x] 1.4 添加配置缺失时的错误提示
- _需求: 需求6（安全性要求）_

---

### T2: 创建微信支付V3工具类

- [x] 2.1 在 `wxpayFunctions/utils/` 目录下创建 `wechatpay.js`
- [x] 2.2 引入 `wechatpay-node-v3` SDK
- [x] 2.3 实现 `getPayInstance()` 获取支付实例（单例模式）
- [x] 2.4 实现 `jsapiOrder()` JSAPI下单方法
- [x] 2.5 实现 `generatePayParams()` 生成小程序支付参数
- [x] 2.6 实现 `queryOrderByOutTradeNo()` 查询订单方法
- _需求: 需求1（微信支付V3下单）、需求3（支付结果查询）_

---

### T3: 重写wxpay_order下单接口

- [x] 3.1 删除原有的 `cloudPay.unifiedOrder` 调用代码
- [x] 3.2 引入配置模块和工具类
- [x] 3.3 从数据库读取订单金额（不信任前端传入金额）
- [x] 3.4 调用 `wechatpay.jsapiOrder()` 获取 prepay_id
- [x] 3.5 调用 `wechatpay.generatePayParams()` 生成支付参数
- [x] 3.6 返回符合前端要求的参数格式（timeStamp、nonceStr、packageVal、signType、paySign）
- [x] 3.7 添加详细的日志记录
- [x] 3.8 完善错误处理
- _需求: 需求1（微信支付V3下单）、需求6（安全性要求）_

---

### T4: 重写wxpay_query查询接口

- [x] 4.1 删除原有的查询代码
- [x] 4.2 引入配置模块和工具类
- [x] 4.3 调用 `wechatpay.queryOrderByOutTradeNo()` 查询订单
- [x] 4.4 处理查询结果，返回标准格式
- [x] 4.5 实现同步更新本地订单状态的逻辑（兜底机制）
- _需求: 需求3（支付结果查询）_

---

### T5: 修改wxpayOrderCallback回调处理

- [x] 5.1 简化回调处理逻辑（云开发已解密）
- [x] 5.2 使用 `event.event_type === "TRANSACTION.SUCCESS"` 判断支付成功
- [x] 5.3 从 `event.resource.out_trade_no` 获取订单号
- [x] 5.4 实现幂等性检查（避免重复处理）
- [x] 5.5 更新 `orders` 集合订单状态
- [x] 5.6 同步更新 `requests` 集合状态
- [x] 5.7 更新商品销量（`products` 集合）
- [x] 5.8 返回 `event` 对象表示处理成功
- _需求: 需求2（支付回调处理）_

---

### T6: 更新package.json依赖

- [x] 6.1 添加 `wechatpay-node-v3` 依赖
- [x] 6.2 更新版本号为 2.0.0
- [x] 6.3 更新描述为"微信支付V3云函数"
- _需求: 技术选型_

---

### T7: 配置云函数环境变量

- [x] 7.1 在云开发控制台配置 `WX_APPID`
- [x] 7.2 配置 `WX_MCHID`（商户号）
- [x] 7.3 配置 `WX_SERIAL_NO`（证书序列号）
- [x] 7.4 配置 `WX_PRIVATE_KEY`（商户私钥）
- [x] 7.5 配置 `WX_APIV3_KEY`（APIv3密钥）
- [x] 7.6 验证环境变量是否正确读取
- _需求: 需求6（安全性要求）_

**注意**: 此步骤需要用户手动在云开发控制台操作

---

### T8: 部署云函数

- [x] 8.1 部署 `wxpayFunctions` 云函数
- [x] 8.2 部署 `wxpayOrderCallback` 云函数
- [x] 8.3 在云开发控制台配置支付回调函数
- [x] 8.4 验证云函数日志正常
- _需求: 所有需求_

---

### T9: 测试验收

#### 测试用例

| 用例ID | 场景 | 操作 | 预期结果 |
|--------|------|------|----------|
| TC-01 | 正常支付 | 选择商品→确认订单→支付0.01元 | 支付成功，订单状态更新为paid |
| TC-02 | 取消支付 | 支付时点击取消 | 订单保持pending_payment，可重新支付 |
| TC-03 | 重新支付 | 从订单列表点击"去支付" | 唤起支付，完成支付 |
| TC-04 | 查询订单 | 支付后查询订单状态 | 返回正确的支付状态 |
| TC-05 | 回调处理 | 支付成功后检查数据库 | 订单状态、requests表、商品销量均正确更新 |
| TC-06 | 幂等性 | 模拟重复回调 | 不重复更新订单状态 |

#### 验收清单

- [x] TC-01 通过
- [x] TC-02 通过
- [x] TC-03 通过
- [x] TC-04 通过
- [x] TC-05 通过
- [x] TC-06 通过

---

## 执行顺序图

```
┌─────┐     ┌─────┐
│ T1  │────>│ T2  │
│配置 │     │工具 │
└─────┘     └──┬──┘
               │
      ┌────────┼────────┐
      │        │        │
      ▼        ▼        ▼
   ┌─────┐  ┌─────┐  ┌─────┐
   │ T3  │  │ T4  │  │ T5  │
   │下单 │  │查询 │  │回调 │
   └──┬──┘  └──┬──┘  └──┬──┘
      │        │        │
      └────────┼────────┘
               │
               ▼
            ┌─────┐
            │ T6  │
            │依赖 │
            └──┬──┘
               │
               ▼
            ┌─────┐
            │ T7  │  ← 需要用户手动配置环境变量
            │环境 │
            └──┬──┘
               │
               ▼
            ┌─────┐
            │ T8  │
            │部署 │
            └──┬──┘
               │
               ▼
            ┌─────┐
            │ T9  │
            │测试 │
            └─────┘
```

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 私钥格式不正确 | 签名失败 | 提供PEM格式要求说明，验证私钥有效性 |
| 环境变量配置错误 | 云函数报错 | 添加配置检查和详细错误提示 |
| wechatpay-node-v3版本问题 | API调用失败 | 锁定稳定版本，参考官方文档 |
| 回调URL配置错误 | 收不到回调 | 使用云开发自动路由，无需手动配置URL |

---

## 需要用户提供的信息

在开始 T7（配置环境变量）之前，需要用户提供：

1. **商户API证书序列号** (WX_SERIAL_NO)
   - 在微信支付商户平台 → API安全 → 查看证书序列号

2. **商户API私钥** (WX_PRIVATE_KEY)
   - 申请API证书时下载的 `apiclient_key.pem` 文件内容
   - 完整的PEM格式，包含 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`

3. **APIv3密钥** (WX_APIV3_KEY)
   - 在微信支付商户平台 → API安全 → 设置APIv3密钥
   - 32位字符串

---

## 下一步

请确认以上任务拆分是否满足要求。确认后我将开始执行 **T1: 创建配置管理模块**。


