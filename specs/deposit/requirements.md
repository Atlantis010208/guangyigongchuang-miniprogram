# 押金缴纳功能需求文档

## 介绍

本功能为光乙共创平台提供押金缴纳机制，用于提升用户服务优先级。押金为可选支付，用户不支付也能正常发布设计需求；若已缴纳押金，用户发布的需求将被标记为"优先"，享受优先处理、客服优先对接等增值服务。订单完成后，押金自动原路退回用户账户。

## 业务规则

1. **押金金额**：¥0.01（测试环境），正式环境可配置为 ¥100
2. **押金数量**：每个用户同时只能有一笔活跃押金
3. **押金状态**：待支付 → 已支付 → 已退款
4. **优先服务**：已缴押金用户发布的需求自动标记为"优先"
5. **退款触发**：任一需求完成（调试验收阶段）后可申请退款，或系统自动退款
6. **退款方式**：原路退回（微信支付退款）

## 需求列表

### 需求 1 - 押金支付

**用户故事**：作为用户，我希望能够缴纳押金，以便我发布的设计需求能获得优先处理。

#### 验收标准

1. When 用户在押金页面点击"立即缴纳押金"按钮, the 系统 shall 检查用户是否已有活跃押金记录。
2. When 用户已有活跃押金记录, the 系统 shall 提示"您已缴纳押金，无需重复缴纳"。
3. When 用户没有活跃押金记录, the 系统 shall 创建押金订单并调用微信支付。
4. When 微信支付成功, the 系统 shall 更新押金状态为"已支付"，并更新用户的优先服务状态。
5. When 微信支付取消或失败, the 系统 shall 保留押金订单为"待支付"状态，用户可重新发起支付。

---

### 需求 2 - 优先服务标记

**用户故事**：作为已缴押金用户，我希望我发布的设计需求能被标记为"优先"，以便获得更快的响应。

#### 验收标准

1. When 用户已缴纳押金且发布设计需求, the 系统 shall 自动将该需求的 `priority` 字段设置为 `true`。
2. When 用户未缴纳押金发布设计需求, the 系统 shall 将该需求的 `priority` 字段设置为 `false`。
3. When 后台管理系统显示设计请求列表, the 系统 shall 对 `priority=true` 的需求显示"优先"标签（橙色）。
4. When 小程序端显示方案订单列表, the 系统 shall 对 `priority=true` 的需求显示"优先"标签。
5. When 小程序端显示方案订单详情, the 系统 shall 对 `priority=true` 的需求显示"优先"标签。

---

### 需求 3 - 押金页面状态展示

**用户故事**：作为用户，我希望在押金页面能清楚看到当前押金状态和相关操作。

#### 验收标准

1. When 用户进入押金页面, the 系统 shall 从云端数据库查询用户的押金状态。
2. When 用户未缴纳押金, the 系统 shall 显示"未缴纳"状态和"立即缴纳押金"按钮。
3. When 用户已缴纳押金, the 系统 shall 显示"已缴纳"状态和"退回押金"按钮。
4. When 用户押金正在退款中, the 系统 shall 显示"退款中"状态，禁用操作按钮。

---

### 需求 4 - 押金退款

**用户故事**：作为已缴押金用户，在订单完成后，我希望押金能够自动退回到我的账户。

#### 验收标准

1. When 用户的任一设计需求状态变更为"调试验收(commission)", the 系统 shall 自动检查该用户是否有已支付的押金。
2. While 用户有已支付押金 and 需求完成, the 系统 shall 自动发起微信退款。
3. When 微信退款成功回调, the 系统 shall 更新押金状态为"已退款"。
4. When 用户在押金页面点击"退回押金", the 系统 shall 检查用户是否有进行中的需求。
5. When 用户没有进行中的需求, the 系统 shall 允许手动申请退款。
6. When 用户有进行中的需求, the 系统 shall 提示"您有进行中的需求，订单完成后押金将自动退回"。
7. When 管理员在后台点击"退回押金"按钮, the 系统 shall 允许管理员手动为用户发起退款（兜底机制）。
8. When 管理员手动退款成功, the 系统 shall 记录操作日志，包含操作人、时间和退款原因。

---

### 需求 5 - 后台管理优先级展示

**用户故事**：作为平台管理员，我希望能在设计请求列表中清楚识别出"优先"用户的需求。

#### 验收标准

1. When 管理员查看设计请求列表, the 系统 shall 在优先级列显示"优先"（橙色标签）或"普通"（灰色标签）。
2. When 管理员使用优先级筛选, the 系统 shall 支持筛选"优先"或"普通"请求。
3. When 管理员查看请求详情, the 系统 shall 在详情弹窗中显示优先级状态。

---

### 需求 6 - 后台押金管理（兜底机制）

**用户故事**：作为平台管理员，我希望能在后台查看和管理用户押金，以便处理特殊情况。

#### 验收标准

1. When 管理员进入押金管理页面, the 系统 shall 显示所有押金记录列表（包含用户信息、金额、状态、时间）。
2. When 管理员使用筛选功能, the 系统 shall 支持按押金状态（待支付/已支付/退款中/已退款）筛选。
3. When 管理员点击"退回押金"操作, the 系统 shall 弹出确认框，要求填写退款原因。
4. When 管理员确认退款, the 系统 shall 调用微信退款接口，并记录操作日志。
5. When 退款失败, the 系统 shall 显示错误信息，允许管理员重试。
6. When 管理员查看押金详情, the 系统 shall 显示押金的完整状态变更日志（包含自动和手动操作记录）。

---

## 设计规范

### 配色方案

- **优先标签**：橙色 (#F97316) 背景，白色文字
- **普通标签**：灰色 (#9CA3AF) 背景，深灰文字
- **已缴纳状态**：绿色 (#10B981)
- **未缴纳状态**：橙色 (#F97316)
- **退款中状态**：蓝色 (#3B82F6)

### 交互规范

1. 支付过程中显示 loading 状态
2. 支付成功后显示成功提示并刷新页面状态
3. 支付失败显示错误信息和重试引导
4. 退款操作需二次确认

---

## 非功能性需求

1. **性能**：押金状态查询响应时间 < 1秒
2. **可靠性**：支付回调需保证幂等性，避免重复处理
3. **安全性**：押金金额从数据库读取，不信任前端传参
4. **可追溯**：押金记录需包含完整的状态变更日志

