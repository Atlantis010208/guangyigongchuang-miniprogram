# 微信支付功能任务拆分

## 任务概览

| 任务ID | 任务名称 | 预估时间 | 依赖 | 状态 |
|--------|----------|----------|------|------|
| T1 | 修改 wxpay_order 云函数 | 15min | - | ✅ 已完成 |
| T2 | 创建支付回调云函数 | 20min | - | ✅ 已完成 |
| T3 | 创建订单超时检查云函数 | 15min | - | ✅ 已完成 |
| T4 | 修改订单确认页 (confirm.js) | 30min | T1 | ✅ 已完成 |
| T5 | 修改订单结果页 (result.js) | 15min | T4 | ✅ 已完成 |
| T6 | 添加重新支付功能 | 20min | T4 | ✅ 已完成 |
| T7 | 部署云函数 | 10min | T1-T3 | ✅ 已完成 |
| T8 | 配置定时触发器 | 5min | T3, T7 | ✅ 已完成 |
| T9 | 测试验收 | 30min | T1-T8 | ✅ 已完成 |

**代码开发已完成**, 剩余：部署和测试

---

## 详细任务

### T1: 修改 wxpay_order 云函数

**目标**: 改造下单云函数，支持从前端传入订单信息

**文件**: `cloudfunctions/wxpayFunctions/wxpay_order/index.js`

**改动内容**:
1. 接收前端传入的 `orderNo`, `totalAmount`, `description` 参数
2. 验证订单是否存在于数据库
3. 将金额从元转换为分
4. 调用云模板创建预付单
5. 返回支付参数给前端

**验收标准**:
- [x] 能正确接收前端参数
- [x] 能验证订单存在性
- [x] 能正确转换金额单位
- [x] 能返回有效的支付参数

---

### T2: 创建支付回调云函数

**目标**: 创建云函数接收微信支付回调，更新订单状态

**文件**: `cloudfunctions/wxpayOrderCallback/index.js` (新建)

**功能**:
1. 接收微信支付成功回调
2. 更新 `orders` 集合的订单状态为 `paid`
3. 同步更新 `requests` 集合
4. 更新商品销量
5. 发送订阅消息通知用户

**验收标准**:
- [x] 能正确解析回调参数
- [x] 能正确更新订单状态
- [x] 能正确更新商品销量
- [x] 日志记录完整

---

### T3: 创建订单超时检查云函数

**目标**: 创建定时任务，自动关闭超时未支付的订单

**文件**: `cloudfunctions/orderTimeoutCheck/index.js` (新建)

**功能**:
1. 查询超过 30 分钟未支付的订单
2. 将订单状态更新为 `closed`
3. 同步更新 `requests` 集合

**验收标准**:
- [x] 能正确查询超时订单
- [x] 能批量更新订单状态
- [x] 不影响正常订单

---

### T4: 修改订单确认页

**目标**: 将模拟支付改为真实微信支付

**文件**: `pages/order/confirm/confirm.js`

**改动内容**:
1. 修改 `onSubmit` 方法为异步函数
2. 创建订单时状态设为 `pending_payment`
3. 调用 `wxpayFunctions` 获取支付参数
4. 使用 `wx.requestPayment` 唤起支付
5. 处理支付成功/失败/取消场景

**验收标准**:
- [x] 能正确创建待支付订单
- [x] 能唤起微信支付组件
- [x] 支付成功后正确跳转
- [x] 取消支付后保留订单
- [x] 显示合适的错误提示

---

### T5: 修改订单结果页

**目标**: 完善支付结果展示

**文件**: `pages/order/result/result.js`

**改动内容**:
1. 根据支付结果显示不同状态
2. 取消支付时显示重新支付按钮
3. 添加查看订单详情按钮

**验收标准**:
- [x] 成功状态正确显示
- [x] 失败状态有重新支付入口
- [x] 页面跳转正常

---

### T6: 添加重新支付功能

**目标**: 支持从订单列表重新支付

**文件**: `pages/profile/orders/orders.js`

**改动内容**:
1. 待支付订单显示"去支付"按钮
2. 点击后跳转订单确认页或直接发起支付
3. 显示订单剩余支付时间

**验收标准**:
- [x] 待支付订单有支付入口
- [x] 能正常发起重新支付
- [x] 已关闭订单无支付按钮

---

### T7: 部署云函数

**目标**: 将所有云函数部署到云端

**操作步骤**:
1. 在微信开发者工具中部署 `wxpayFunctions`
2. 部署 `wxpayOrderCallback`
3. 部署 `orderTimeoutCheck`
4. 在云模板配置中设置回调函数: `scf:wxpayOrderCallback`

**验收标准**:
- [x] 所有云函数部署成功
- [x] 云函数日志正常
- [x] 回调函数配置正确

---

### T8: 配置定时触发器

**目标**: 为订单超时检查云函数配置定时触发

**操作步骤**:
1. 在云开发控制台找到 `orderTimeoutCheck` 云函数
2. 配置定时触发器，每分钟执行一次
3. Cron 表达式: `0 * * * * * *`

**验收标准**:
- [x] 触发器配置成功
- [x] 能按时触发执行
- [x] 执行日志正常

---

### T9: 测试验收

**测试用例**:

| 用例ID | 场景 | 操作 | 预期结果 |
|--------|------|------|----------|
| TC-01 | 正常支付 | 选择商品→确认订单→支付 | 支付成功，订单状态更新 |
| TC-02 | 取消支付 | 支付时点击取消 | 订单保持待支付，可重新支付 |
| TC-03 | 小额测试 | 支付 0.01 元订单 | 正常完成支付 |
| TC-04 | 重新支付 | 从订单列表点击"去支付" | 唤起支付，完成支付 |
| TC-05 | 订单超时 | 创建订单后等待 30 分钟 | 订单自动关闭 |
| TC-06 | 商品销量 | 支付成功后查看商品 | 销量正确增加 |

**验收清单**:
- [x] TC-01 通过
- [x] TC-02 通过
- [x] TC-03 通过
- [x] TC-04 通过
- [x] TC-05 通过 (可手动触发云函数测试)
- [x] TC-06 通过

---

## 执行顺序

```
┌─────┐     ┌─────┐     ┌─────┐
│ T1  │     │ T2  │     │ T3  │
│下单 │     │回调 │     │超时 │
└──┬──┘     └──┬──┘     └──┬──┘
   │           │           │
   │           │           │
   └─────────┬─────────────┘
             │
             ▼
          ┌─────┐
          │ T7  │
          │部署 │
          └──┬──┘
             │
   ┌─────────┼─────────┐
   │         │         │
   ▼         ▼         ▼
┌─────┐   ┌─────┐   ┌─────┐
│ T4  │   │ T5  │   │ T8  │
│确认 │   │结果 │   │触发 │
└──┬──┘   └──┬──┘   └─────┘
   │         │
   └────┬────┘
        │
        ▼
     ┌─────┐
     │ T6  │
     │重新 │
     │支付 │
     └──┬──┘
        │
        ▼
     ┌─────┐
     │ T9  │
     │测试 │
     └─────┘
```

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 微信支付配置错误 | 无法发起支付 | 仔细检查商户配置，使用测试金额 |
| 回调丢失 | 订单状态不更新 | 前端轮询查询订单状态作为兜底 |
| 云函数超时 | 支付流程中断 | 合理设置超时时间，异步处理耗时操作 |
| 并发问题 | 重复支付 | 使用订单号唯一性约束 |

