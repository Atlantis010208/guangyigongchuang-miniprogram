# 微信支付功能需求文档

## 1. 项目背景

光乙共创平台小程序需要集成微信支付功能，将现有的模拟支付流程改为真实的微信支付，实现电子商城的在线收款功能。

## 2. 配置信息

| 配置项 | 值 |
|--------|-----|
| AppID | wxe8b6b3aed51577e0 |
| 商户号 | 1734489422 |
| 云环境ID | cloud1-5gb9c5u2c58ad6d7 |
| 云模板 | wxpayFunctions（已下载） |

## 3. 功能需求

### 3.1 支付下单

**FR-001**: 用户在订单确认页点击"提交订单"按钮后，系统应调用微信支付云模板创建预付单。

**FR-002**: 系统应生成唯一的商户订单号（out_trade_no），格式为 `{时间戳}_{随机字符串}`。

**FR-003**: 支付金额应从订单商品计算得出，支持小额测试（如 0.01 元）。

**FR-004**: 预付单创建成功后，应自动唤起微信支付组件。

### 3.2 支付回调

**FR-005**: 支付成功后，系统应通过云函数接收微信支付通知。

**FR-006**: 支付成功后，系统应更新订单状态为"已支付"（paid）。

**FR-007**: 支付成功后，系统应更新对应商品的库存和销量。

**FR-008**: 支付成功后，系统应发送订阅消息通知用户（如果用户已授权）。

### 3.3 支付失败处理

**FR-009**: 用户取消支付后，订单应保留为"待支付"状态，允许重新支付。

**FR-010**: 订单超时（30分钟）未支付，系统应自动关闭订单。

**FR-011**: 支付失败时，应向用户展示明确的失败原因。

### 3.4 订单查询

**FR-012**: 系统应支持根据商户订单号查询支付状态。

## 4. 非功能需求

### 4.1 安全性

**NFR-001**: 支付金额验证必须在云函数中完成，不信任前端传入的金额。

**NFR-002**: 订单号生成必须保证唯一性，防止重复支付。

**NFR-003**: 支付回调必须验证来自微信官方。

### 4.2 可靠性

**NFR-004**: 支付流程应支持掉线重连，订单状态可恢复。

**NFR-005**: 支付回调处理失败时，应支持重试机制。

### 4.3 性能

**NFR-006**: 预付单创建响应时间应小于 3 秒。

**NFR-007**: 支付回调处理响应时间应小于 1 秒。

## 5. 验收标准

### AC-001: 正常支付流程
- [ ] 用户可以在订单确认页提交订单
- [ ] 系统成功调用微信支付云模板创建预付单
- [ ] 微信支付组件正确唤起
- [ ] 支付成功后订单状态更新为"已支付"
- [ ] 支付成功后商品销量正确增加
- [ ] 支付成功后用户收到订阅消息通知

### AC-002: 取消支付流程
- [ ] 用户取消支付后订单保持"待支付"状态
- [ ] 用户可以从订单列表重新进入支付
- [ ] 重新支付成功后流程正常完成

### AC-003: 超时订单处理
- [ ] 订单创建 30 分钟后自动关闭
- [ ] 关闭的订单状态更新为"已关闭"
- [ ] 用户无法对已关闭订单进行支付

### AC-004: 小额测试
- [ ] 支持 0.01 元的小额支付测试
- [ ] 支付金额正确显示在支付组件中

## 6. 影响范围

### 6.1 需要修改的文件
- `cloudfunctions/wxpayFunctions/wxpay_order/index.js` - 下单云函数
- `cloudfunctions/wxpayFunctions/wxpay_query_order_by_out_trade_no/index.js` - 查询订单
- `pages/order/confirm/confirm.js` - 订单确认页
- `pages/order/result/result.js` - 支付结果页
- `pages/profile/orders/orders.js` - 订单列表页（重新支付）

### 6.2 需要新增的文件
- `cloudfunctions/wxpayOrderCallback/index.js` - 支付回调云函数
- `cloudfunctions/orderTimeoutCheck/index.js` - 订单超时检查云函数

### 6.3 涉及的数据库集合
- `orders` - 订单集合（更新支付状态）
- `requests` - 需求集合（同步状态）
- `products` - 商品集合（更新销量）

## 7. 排除范围

本次开发**不包含**以下功能：
- 退款功能（后续迭代实现）
- 多商户支持
- 分账功能
- 代金券/优惠券支付

## 8. 术语定义

| 术语 | 定义 |
|------|------|
| out_trade_no | 商户订单号，由商户系统生成的唯一订单标识 |
| transaction_id | 微信支付订单号，由微信支付系统生成 |
| prepay_id | 预支付交易会话标识，用于唤起支付组件 |
| 云模板 | 腾讯云开发提供的微信支付集成模板 |

