# 退款退货功能需求文档

## 介绍

为光乙共创平台电子商城添加完整的退款退货功能，支持用户在订单支付后申请「仅退款」或「退货退款」，经商家审核后完成退款流程。金额将原路退回用户微信账户。

## 业务流程概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户发起退款申请                          │
│           订单详情页 → "申请退货"按钮 → 选择退款类型               │
└─────────────────────────────────────────────────────────────────┘
                                 │
              ┌──────────────────┴──────────────────┐
              ▼                                      ▼
     ┌─────────────────┐                    ┌─────────────────┐
     │    仅退款流程    │                    │    退货流程     │
     │ (虚拟商品/特殊)  │                    │  (实物商品)     │
     └─────────────────┘                    └─────────────────┘
              │                                      │
              ▼                                      ▼
     ┌─────────────────┐                    ┌─────────────────┐
     │ 阶段1: 商家处理  │                    │ 阶段1: 商家处理  │
     │   等待审核      │                    │   等待审核      │
     │  (48小时内)     │                    │  (48小时内)     │
     └─────────────────┘                    └─────────────────┘
              │                                      │
     ┌────────┴────────┐                    ┌────────┴────────┐
     ▼                 ▼                    ▼                 ▼
  同意退款          拒绝退款            同意退货          拒绝退货
     │                 │                    │                 │
     ▼                 ▼                    ▼                 ▼
┌──────────┐    ┌──────────┐         ┌──────────────┐   ┌──────────┐
│ 阶段2:   │    │用户可再次 │         │ 阶段2:       │   │用户可再次 │
│ 退款结束 │    │ 申请退款 │         │ 寄回商品     │   │ 申请退款 │
│ (原路退回)│    └──────────┘         │ (用户自行寄) │   └──────────┘
└──────────┘                         └──────────────┘
                                            │
                                            ▼
                                     ┌──────────────┐
                                     │ 商家确认收货  │
                                     └──────────────┘
                                            │
                                            ▼
                                     ┌──────────────┐
                                     │ 阶段3:       │
                                     │ 退款结束     │
                                     │ (原路退回)   │
                                     └──────────────┘
```

---

## 需求清单

### 需求 1 - 订单详情页改造

**用户故事：** 作为用户，我希望在已支付订单的详情页中看到「申请退货」按钮，以便发起退款申请。

#### 验收标准

1. When 订单状态为「已支付」时，the 订单详情页 shall 将原「撤销」按钮替换为「申请退货」按钮。
2. When 订单状态不为「已支付」时，the 订单详情页 shall 不显示「申请退货」按钮。
3. When 订单已存在退款申请记录时，the 订单详情页 shall 显示「查看退款」按钮，跳转至退款详情页。
4. When 用户点击「申请退货」按钮时，the 系统 shall 弹出底部弹窗显示「仅退款」和「退货」两个选项。

---

### 需求 2 - 退款类型选择

**用户故事：** 作为用户，我希望能选择「仅退款」或「退货」两种退款方式，以适应不同的退款场景。

#### 验收标准

1. When 用户点击「申请退货」按钮时，the 系统 shall 显示底部弹窗（ActionSheet），包含「仅退款」和「退货」两个选项。
2. When 用户选择「仅退款」时，the 系统 shall 跳转至退款申请页面，退款类型标记为 `refund_only`。
3. When 用户选择「退货」时，the 系统 shall 跳转至退款申请页面，退款类型标记为 `return_refund`。
4. When 用户取消弹窗时，the 系统 shall 关闭弹窗，不进行任何操作。

---

### 需求 3 - 退款申请页面

**用户故事：** 作为用户，我希望在退款申请页面填写退款原因并上传凭证图片，以便商家了解退款情况。

#### 验收标准

1. The 退款申请页面 shall 显示订单基本信息（订单号、商品信息、金额）。
2. The 退款申请页面 shall 提供退款原因选择下拉框，包含以下选项：
   - 商品质量问题
   - 商品与描述不符
   - 收到商品损坏
   - 发错货/漏发货
   - 不想要了/拍多了
   - 其他原因
3. When 用户选择「其他原因」时，the 系统 shall 显示文本输入框供用户填写详细说明。
4. The 退款申请页面 shall 提供图片上传区域，最多支持上传 9 张凭证图片。
5. When 用户点击图片上传区域时，the 系统 shall 允许用户从相册选择或拍照上传图片。
6. The 退款申请页面 shall 显示「提交申请」按钮，按钮样式延续苹果风格设计。
7. When 用户未选择退款原因时点击「提交申请」，the 系统 shall 提示「请选择退款原因」。
8. When 用户提交申请成功时，the 系统 shall 跳转至退款详情页，并显示当前退款进度。

---

### 需求 4 - 退款详情页（步骤条展示）

**用户故事：** 作为用户，我希望在退款详情页看到清晰的退款进度，了解当前处于哪个阶段。

#### 验收标准

1. The 退款详情页顶部 shall 使用 [Vant Weapp Steps 步骤条组件](https://vant-ui.github.io/vant-weapp/#/steps) 展示退款进度。
2. While 退款类型为「仅退款」时，the 步骤条 shall 显示 2 个步骤：「商家处理」→「退款结束」。
3. While 退款类型为「退货」时，the 步骤条 shall 显示 3 个步骤：「商家处理」→「寄回商品」→「退款结束」。
4. The 步骤条 shall 根据当前退款状态高亮对应步骤。
5. The 退款详情页 shall 显示退款申请信息（退款类型、退款原因、凭证图片、申请时间）。
6. The 退款详情页 shall 显示退款状态及说明文字。
7. When 商家拒绝退款时，the 退款详情页 shall 显示拒绝原因及「重新申请」按钮。
8. When 退款类型为「退货」且商家已同意时，the 退款详情页 shall 显示「请与商家沟通获取收货地址，自行寄回商品」提示。

---

### 需求 5 - 退款状态管理

**用户故事：** 作为系统，我需要维护完整的退款状态流转，确保流程可追溯。

#### 验收标准

1. The 系统 shall 定义以下退款状态（使用中文）：

   | 状态值 | 状态名 | 说明 |
   |--------|--------|------|
   | `待审核` | 待审核 | 用户已提交申请，等待商家审核 |
   | `已同意` | 已同意 | 商家同意退款/退货 |
   | `已拒绝` | 已拒绝 | 商家拒绝退款申请 |
   | `待寄回` | 待寄回 | 等待用户寄回商品（仅退货流程） |
   | `待确认收货` | 待确认收货 | 商品已寄回，等待商家确认收货 |
   | `退款中` | 退款中 | 正在执行退款操作 |
   | `已退款` | 已退款 | 退款成功完成 |
   | `退款失败` | 退款失败 | 退款执行失败 |
   | `已取消` | 已取消 | 用户取消退款申请 |

2. When 退款状态变更时，the 系统 shall 记录状态变更日志（时间、操作人、原因）。

---

### 需求 6 - 商家后台售后管理

**用户故事：** 作为商家，我希望在管理后台的订单管理页面看到售后状态，并能进行审核操作。

#### 验收标准

1. The 订单管理页面 shall 新增「售后状态」列，显示以下三种状态：
   - `无售后` - 该订单没有退款申请
   - `待售后` - 该订单有待处理的退款申请
   - `售后完成` - 该订单的退款已完成

2. The 订单管理页面 shall 支持按「售后状态」筛选订单。

3. When 商家点击「待售后」状态的订单时，the 系统 shall 显示退款详情弹窗或跳转退款详情页。

4. The 退款详情弹窗 shall 显示：
   - 退款单号、退款类型、退款金额
   - 退款原因、详细说明
   - 凭证图片（可点击查看大图）
   - 申请时间、当前状态

5. While 退款状态为「待审核」时，the 商家 shall 可执行「同意」或「拒绝」操作。

6. When 商家选择「拒绝」时，the 系统 shall 要求商家填写拒绝原因。

7. While 退款类型为「退货」且状态为「待确认收货」时，the 商家 shall 可执行「确认收货」操作。

8. When 商家执行「确认收货」后，the 系统 shall 自动触发退款流程。

9. The 系统 shall 在审核操作后 48 小时内完成处理，超时未处理的申请 shall 显示超时提醒标识。

---

### 需求 7 - 微信支付退款

**用户故事：** 作为系统，我需要调用微信支付 V3 退款 API，将款项原路退回用户账户。

#### 验收标准

1. The 系统 shall 调用微信支付 V3 API 申请退款接口 `/v3/refund/domestic/refunds`。
2. The 系统 shall 创建 `wxpayRefundCallback` 云函数接收退款结果通知。
3. When 退款成功时，the 系统 shall 更新退款记录状态为「已退款」。
4. When 退款成功时，the 系统 shall 更新原订单状态为「已退款」。
5. When 退款失败时，the 系统 shall 记录失败原因并自动重试（最多 3 次）。
6. When 重试仍失败时，the 系统 shall 将状态标记为「退款失败」，等待人工处理。

---

### 需求 8 - 退款记录数据模型

**用户故事：** 作为开发者，我需要设计退款记录的数据结构以支撑业务流程。

#### 验收标准

1. The 系统 shall 在云数据库创建 `refunds` 集合存储退款记录。
2. The 退款记录 shall 包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `_id` | String | 退款记录ID |
| `refundNo` | String | 退款单号（唯一） |
| `orderNo` | String | 关联订单号 |
| `userId` | String | 用户OpenID |
| `refundType` | String | 退款类型：`refund_only` / `return_refund` |
| `refundAmount` | Number | 退款金额（元） |
| `reason` | String | 退款原因 |
| `reasonDetail` | String | 详细说明（其他原因时） |
| `images` | Array | 凭证图片列表（云存储fileID） |
| `status` | String | 退款状态（中文） |
| `statusLogs` | Array | 状态变更日志 |
| `rejectReason` | String | 拒绝原因（商家拒绝时） |
| `wxRefundId` | String | 微信退款单号 |
| `refundedAt` | Date | 退款成功时间 |
| `createdAt` | Date | 申请时间 |
| `updatedAt` | Date | 更新时间 |
| `retryCount` | Number | 退款重试次数 |

---

### 需求 9 - 订单状态扩展

**用户故事：** 作为系统，我需要扩展订单状态和售后状态以支持退款流程。

#### 验收标准

1. The 系统 shall 扩展订单状态（中文），新增以下状态：
   - `退款申请中` - 用户已提交退款申请
   - `退款中` - 正在执行退款
   - `已退款` - 退款成功完成

2. The 系统 shall 新增订单「售后状态」字段 `afterSaleStatus`，包含以下值：
   - `无售后` - 默认值，没有退款申请
   - `待售后` - 有待处理的退款申请
   - `售后完成` - 退款已完成

3. When 用户提交退款申请时，the 订单售后状态 shall 变更为 `待售后`。
4. When 退款成功完成时，the 订单售后状态 shall 变更为 `售后完成`，订单状态变更为 `已退款`。
5. When 退款申请被取消或拒绝时，the 订单售后状态 shall 恢复为 `无售后`（如无其他进行中的申请）。

---

## 设计规范

### 界面风格
- 延续现有苹果设计风格
- 使用 Vant Weapp Steps 步骤条组件
- 配色与现有项目保持一致

### 按钮样式
- 主按钮：黑色边框，白色背景
- 危险按钮：红色文字（用于拒绝等操作）
- 圆角：50rpx

---

## 非功能需求

1. **安全性**：退款金额从数据库读取，不信任前端传入
2. **幂等性**：退款回调需做幂等处理，避免重复退款
3. **超时处理**：48小时未处理的申请需提醒商家
4. **日志记录**：所有状态变更需记录完整日志

---

## 依赖组件

- [Vant Weapp Steps 步骤条](https://vant-ui.github.io/vant-weapp/#/steps)
- [Vant Weapp ActionSheet 动作面板](https://vant-ui.github.io/vant-weapp/#/action-sheet)
- [Vant Weapp Uploader 文件上传](https://vant-ui.github.io/vant-weapp/#/uploader)

---

## 相关资源

### 管理后台
- 项目路径：`c:\Users\imac\Desktop\guangyi\Backend-management\guangyi-admin`
- 订单管理页面：`src/pages/business/OrderList.tsx`

### 小程序
- 项目路径：`c:\Users\imac\Desktop\guangyi\20250925-miniprogram-4`
- 订单详情页面：`pages/order/detail/detail.wxml`

---

## 版本信息

- 文档版本：v1.1
- 创建时间：2025-12-19
- 更新时间：2025-12-19
- 作者：AI Assistant
- 更新说明：
  - v1.1: 订单状态改为中文；新增订单售后状态字段；移除微信服务通知需求
