# 光乙共创平台小程序项目

基于微信小程序开发的苹果官方风格应用，完美复刻苹果官方小程序的设计和交互体验。

## 项目特色

### 🎨 设计特色
- **苹果设计语言**：完美还原苹果官方设计风格
- **现代化界面**：简洁清爽的卡片式设计
- **响应式布局**：适配各种屏幕尺寸
- **深色模式支持**：自动适配系统主题

### ⚡ 功能特色
- **灯光方案展示**：灯光设计服务与空间分类展示
- **分类浏览**：住宅照明、商业照明、办公照明、酒店照明等空间分类
- **智能搜索**：支持搜索建议、历史记录和热门搜索
- **购物体验**：完整的购物袋功能，支持商品管理（电子商城）
- **内容探索**：精选照明内容、灯光设计课程、照明知识学习

## 页面结构

### 📱 产品页面 (`/pages/products/`)
- 页面头部：灯光方案标题与个人中心入口
- 预算预估弹窗：首次进入时的5步预算预估流程（面积、空间类型、服务类型、设计预算、费用结果）
- 灯光空间分类：横向滚动展示（住宅照明、商业照明、办公照明、酒店照明）
- 我的灯光助手：横向滚动卡片（灯光工具包、十年经验二哥灯光设计课）
- 发布灯光需求：横向滚动服务卡片（选灯配灯服务、优化灯光施工图、整套灯光设计）
- 表达您的需求：横向滚动卡片（发布照明需求、个性需求定制）
- 电子商城入口：精选灯具与配件入口
- 节能妙招：高效光源与智能调光推荐
- 照明内容：新方案、光学知识、调光技巧、选型指南等标签
- 官方支持：二维码与客服联系方式

### 🔍 深入探索页面 (`/pages/explore/`)
- 精选内容轮播
- 新发布产品资讯
- 学技能课程推荐
- Today at Apple 活动

### 🔎 搜索页面 (`/pages/search/`)
- 实时搜索建议
- 智能搜索结果
- 热门搜索标签
- 推荐分类导航
- 搜索历史管理

### 🛒 购物袋页面 (`/pages/cart/`)
- 购物车商品管理
- 数量调整和删除
- 稍后购买功能
- 推荐商品展示
- 结算功能

## 技术特点

### 🛠 技术栈
- **框架**：微信小程序原生开发
- **后端**：微信云开发（CloudBase）
- **数据库**：云开发云数据库（MongoDB 风格）
- **支付**：微信支付云模板
- **样式**：苹果设计系统 + 响应式布局
- **组件**：模块化组件设计
- **状态管理**：本地存储 + 全局状态 + 云数据库

### 🎯 核心功能
- **触觉反馈**：支持 iPhone 震动反馈
- **本地存储**：搜索历史、购物车数据持久化
- **网络状态**：自动检测和处理网络状态
- **错误处理**：完善的错误处理机制
- **性能优化**：防抖节流、懒加载等优化
- **微信支付**：完整的支付流程，支持重新支付

## 💳 微信支付功能


### 支付流程
1. 用户在订单确认页点击"提交订单"
2. 系统调用 `wxpayFunctions` 云函数创建预付单
3. 前端调用 `wx.requestPayment` 唤起微信支付
4. 支付成功后，云函数 `wxpayOrderCallback` 接收回调
5. 更新订单状态、商品销量，发送通知

### 支付相关云函数
| 云函数名 | 功能 |
|----------|------|
| wxpayFunctions | 微信支付路由（下单、查询等） |
| wxpayOrderCallback | 支付成功回调处理 |
| orderTimeoutCheck | 订单超时自动关闭（定时触发） |

### 订单状态
- `pending_payment` - 待支付（30分钟后自动关闭）
- `paid` - 已支付
- `shipped` - 已发货
- `completed` - 已完成
- `closed` - 已关闭（超时或取消）
- `refund_pending` - 退款申请中
- `refunding` - 退款处理中
- `refunded` - 已退款

### 售后状态
- `无售后` - 无售后申请
- `待售后` - 有待处理的退款申请
- `售后完成` - 售后已处理完成

### 部署步骤
1. 在云开发控制台安装微信支付云模板
2. 配置商户号、密钥等商户信息
3. 部署 `wxpayOrderCallback` 云函数
4. 在云模板配置中设置回调函数：`scf:wxpayOrderCallback`
5. 部署 `orderTimeoutCheck` 云函数并配置定时触发器
6. 部署其他云函数（`wxpayFunctions`、`mall_orders_list` 等）

详细技术设计文档见：`specs/wechat_payment/design.md`

## 🔄 退款退货功能

### 功能概述
支持用户对已支付订单申请退款或退货，包含完整的售后流程管理。

### 退款类型
1. **仅退款**：适用于虚拟商品或无需退货的情况
   - 流程：申请 → 商家审核 → 退款完成
   - 阶段：商家处理 → 退款结束

2. **退货退款**：适用于实物商品需要退回的情况
   - 流程：申请 → 商家审核 → 用户寄回 → 商家确认收货 → 退款完成
   - 阶段：商家处理 → 寄回商品 → 退款结束

### 退款状态流转
```
pending（待审核）
    ├── approved（已同意）→ refunding（退款中）→ success（退款成功）
    │                                        └── failed（退款失败）→ 重试
    ├── rejected（已拒绝）→ 用户可重新申请
    └── cancelled（已取消）
    
退货流程额外状态：
approved → return_pending（待寄回）→ return_shipped（已寄回）→ return_received（已收货）→ refunding
```

### 退款相关云函数
| 云函数名 | 功能 |
|----------|------|
| refund_apply | 用户提交退款申请 |
| refund_detail | 查询退款详情 |
| refund_cancel | 用户取消退款申请 |
| admin_refunds_list | 商家查询退款列表 |
| admin_refunds_update | 商家审核/确认收货 |
| wxpayRefundCallback | 微信支付退款回调 |
| wxpayFunctions (wxpay_refund) | 发起微信支付退款 |
| wxpayFunctions (wxpay_refund_query) | 查询退款状态 |

### 退款相关页面
| 页面路径 | 功能 |
|----------|------|
| pages/refund/apply/apply | 退款申请页（填写原因、上传凭证） |
| pages/refund/detail/detail | 退款详情页（Steps步骤条、状态展示） |
| pages/order/detail/detail | 订单详情页（申请退货入口） |

### 数据库集合
- **refunds**：退款记录集合
  - 字段：refundNo, orderNo, refundType, status, reason, images, amount 等
  - 索引：orderNo, openid, status, createdAt

- **orders** 扩展字段：
  - `afterSaleStatus`：售后状态（无售后/待售后/售后完成）

### 管理后台改造
- 订单列表新增「售后状态」列
- 支持查看退款申请详情
- 支持审核通过/拒绝退款
- 支持确认收货（退货流程）

## 💰 押金缴纳功能

### 功能概述
用户可以选择性缴纳押金以享受"优先"服务。押金在订单完成后自动原路退回。

### 押金规则
1. **可选支付**：押金为可选支付，不缴纳也可发布设计需求
2. **优先服务**：已缴纳押金的用户发布的需求标记为"优先"
   - 优先处理
   - 客服优先对接
3. **自动退回**：订单完成后系统自动原路退回押金
4. **一人一笔**：每个用户同一时间只能有一笔活跃押金

### 押金状态
| 状态 | 说明 |
|------|------|
| `pending` | 待支付（已创建订单但未支付） |
| `paid` | 已支付（享受优先服务） |
| `refunding` | 退款中（已发起退款申请） |
| `refunded` | 已退款（押金已退回） |
| `refund_failed` | 退款失败（可重试） |

### 押金相关云函数
| 云函数名 | 功能 |
|----------|------|
| deposit_create | 创建押金订单并发起微信支付 |
| deposit_query | 查询用户押金状态 |
| deposit_refund | 用户/管理员申请押金退款 |
| admin_deposits_list | 管理后台查询押金列表 |
| wxpayOrderCallback | 支持押金支付成功回调 |
| wxpayRefundCallback | 支持押金退款回调 |

### 押金相关页面
| 页面路径 | 功能 |
|----------|------|
| pages/profile/deposit/deposit | 押金缴纳/退款页面 |

### 数据库集合
- **deposits**：押金记录集合
  - 字段：depositNo, userId, amount, status, paidAt, refundedAt, statusLogs 等
  - 索引：userId, status, depositNo(唯一), createdAt

- **users** 扩展字段：
  - `depositPaid`：是否已缴纳押金
  - `depositId`：当前活跃押金记录ID

- **requests** 扩展字段：
  - `priority`：是否优先处理（缴纳押金时为 true）

### 管理后台功能
- 押金管理页面：`/business/deposits`
  - 查看所有用户押金记录
  - 按状态筛选
  - 管理员手动退款（兜底机制）
  - 查看状态变更日志

详细技术设计文档见：`specs/deposit/design.md`

---

### 退款原因选项
1. 不想要了/买错了
2. 商品与描述不符
3. 质量问题
4. 收到商品损坏
5. 发错货/漏发
6. 其他原因

### UI 组件
- 使用 **Vant Weapp** 组件库
- Steps 步骤条展示退款进度
- ActionSheet 选择退款类型
- Uploader 上传凭证图片（最多9张）

详细技术设计文档见：`specs/refund_return/design.md`

## 文件结构

```
miniprogram-4/
├── app.js                    # 应用入口文件
├── app.json                  # 全局配置
├── app.wxss                  # 全局样式
├── images/                   # 图片资源
├── pages/                    # 页面文件
│   ├── products/             # 产品页面
│   ├── explore/              # 深入探索页面
│   ├── search/               # 搜索页面
│   ├── cart/                 # 购物袋页面
│   ├── mall/                 # 电子商城
│   ├── order/                # 订单相关
│   │   ├── confirm/          # 订单确认页（支付入口）
│   │   ├── result/           # 支付结果页
│   │   └── detail/           # 订单详情页（含退货入口）
│   ├── refund/               # 退款相关
│   │   ├── apply/            # 退款申请页
│   │   └── detail/           # 退款详情页
│   └── profile/              # 个人中心
│       └── orders/           # 我的订单（含售后状态）
├── cloudfunctions/           # 云函数目录
│   ├── wxpayFunctions/       # 微信支付路由（V3 API）
│   │   ├── wxpay_order/      # JSAPI下单接口
│   │   ├── wxpay_query_.../  # 订单查询接口
│   │   ├── wxpay_refund/     # 退款接口
│   │   ├── wxpay_refund_query/ # 退款查询接口
│   │   ├── config/           # 支付配置（商户号、密钥等）
│   │   └── utils/            # 支付工具类（签名、请求）
│   ├── wxpayOrderCallback/   # 支付成功回调
│   ├── wxpayRefundCallback/  # 退款回调处理
│   ├── refund_apply/         # 用户申请退款
│   ├── refund_detail/        # 退款详情查询
│   ├── refund_cancel/        # 取消退款申请
│   ├── admin_refunds_list/   # 商家退款列表
│   ├── admin_refunds_update/ # 商家审核退款
│   ├── orderTimeoutCheck/    # 订单超时检查
│   ├── orders_create/        # 创建订单
│   ├── orders_update/        # 更新订单
│   └── mall_orders_list/     # 查询订单列表
├── specs/                    # 技术文档
│   ├── wechat_payment/       # 微信支付功能
│   │   ├── requirements.md   # 需求文档
│   │   ├── design.md         # 技术设计
│   │   └── tasks.md          # 任务拆分
│   ├── wechat_payment_v3/    # 微信支付V3升级
│   │   └── tasks.md          # 任务拆分
│   └── refund_return/        # 退款退货功能
│       ├── requirements.md   # 需求文档
│       ├── design.md         # 技术设计
│       └── tasks.md          # 任务拆分
├── utils/                    # 工具函数
│   ├── util.js               # 通用工具函数
│   └── api.js                # API 封装
└── README.md                 # 项目说明
```

## 使用说明

### 开发环境
1. 安装微信开发者工具
2. 导入项目目录
3. 配置 AppID（如需真机预览）

### 图片资源
项目中的图片资源需要根据实际需求添加：
- 灯光空间图片：住宅照明、商业照明、办公照明、酒店照明等场景图片
- 服务展示图片：选灯配灯、施工图优化、整套设计等服务相关图片
- 图标文件：标签栏图标、功能图标等
- 占位图片：默认头像、空状态图片等
- 个人资料页：头像编辑图标 `/images/加.png`
 - 反馈类型页：功能建议图标 `/images/功能建议单.png`，问题反馈图标 `/images/问题反馈.png`，投诉图标 `/images/投诉.png`，其他图标 `/images/其他服务.png`

### 自定义配置
- 修改 `app.json` 中的页面配置
- 调整 `app.wxss` 中的全局样式
- 更新 `utils/util.js` 中的工具函数

## 设计亮点

### 🎨 视觉设计
- **色彩搭配**：使用苹果官方配色方案
- **字体层级**：完整的字体大小和权重体系
- **间距规范**：统一的边距和内边距规范
- **阴影效果**：柔和的投影和光影效果

### 🔄 交互体验
- **流畅动画**：微妙的过渡动画效果
- **手势操作**：支持滑动、点击等手势
- **反馈机制**：即时的视觉和触觉反馈
- **状态管理**：清晰的加载和错误状态

## 兼容性

- **微信版本**：支持微信 7.0+ 版本
- **系统要求**：iOS 10+ / Android 5.0+
- **分辨率**：自适应各种屏幕分辨率
- **性能**：优化后运行流畅

## 许可证

本项目仅供学习和参考使用，请勿用于商业用途。

## 联系方式

如有问题或建议，欢迎提交 Issue 或 Pull Request。

---

*本项目灵感来源于苹果官方小程序，致敬苹果优秀的设计理念。*


## 功能补充（保持现有界面布局样式不变，聚焦“灯光设计”方向）

以下为围绕“灯光设计/照明设计”业务补充的功能清单，分为「用户端」「照明设计师端」「平台管理后台」三端。保持现有 UI 布局与样式不变，仅补业务字段、流程与数据接口。

### 1）用户端功能（甲方/业主）
- 用户注册/登录：微信授权、手机绑定、密码找回
- 需求发布（照明）：空间类型与面积（住宅/商业/办公/酒店等）、照明目标（氛围/显色/眩光控制/均匀度/照度目标）、控制方式（单路/分路/调光/DALI/蓝牙）、能耗上限与预算、风格偏好与特殊约束（如灯位受限、层高受限）
- 设计师筛选与预约：按擅长空间、案例、照度计算经验、资质与评分筛选照明设计师；查看光环境案例、灯具清单样例与评价；发送预约
- 进度跟踪：勘测 → 概念方案 → 布灯图/回路图 → 照度/UGR计算 → 选型清单/报价 → 施工配合 → 调试验收；各阶段可查看进度与里程碑
- 消息通知：阶段变更、方案评论、文件更新、调试安排等
- 个人中心：我的需求/订单/收藏、文件与图片归档、发票与合同管理

### 2）照明设计师端功能
- 需求接单系统：接收照明需求推送；按空间类型/项目体量/地区/工期进行筛选；支持抢单/后台派单
- 方案提交与管理：上传 Dialux/Relux 计算文件、CAD/REVIT 布灯图、IES 文件、灯具明细（型号/功率/光束角/色温/显指/UGR/配光曲线）、PDF 提交稿；版本管理与在线预览/下载
- 订单管理：按阶段管理任务与截至时间；记录现场勘查、照度计算结果、调试验收单；完成后归档
- 个人信息管理：完善设计师资料、资质证书与签章，设置接单状态与可服务城市

### 3）平台管理后台功能
- 用户/设计师管理：实名认证、设计师资质审核、黑名单管理
- 订单与交付管理：项目进度流转、合同与收付款、纠纷处理、绩效统计（签约转化、平均工期、复购率）
- 资料与内容库：灯具品牌与型号库（含 IES、参数与图片）、标准化模板（布灯图/清单/报告）、案例库与内容运营位
- 数据分析：项目成本/毛利、能耗与节能模拟、灯具品牌占比、区域热力图，支持导出
- 系统设置：权限与角色、计费与开票、存储与文件安全、审计日志

> 说明：以上为“灯光设计”方向的业务化文本替换与功能补充，不影响现有页面的排版与视觉，仅扩展字段、流程节点及接口数据结构。
