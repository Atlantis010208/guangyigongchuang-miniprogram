<scroll-view class="page" scroll-y>
  <!-- è®¢å•çŠ¶æ€å¤´éƒ¨ -->
  <view class="status-header">
    <!-- å·²å®Œæˆ -->
    <image 
      class="status-icon-img" 
      wx:if="{{order.status === 'å·²å®Œæˆ' || order.status === 'completed'}}"
      src="/images/å·²å®Œæˆ.png" 
      mode="aspectFit"
    />
    <!-- å·²å‘è´§ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å·²å‘è´§' || order.status === 'shipped'}}"
      src="/images/å·²å‘è´§.png" 
      mode="aspectFit"
    />
    <!-- å·²æ”¯ä»˜ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å·²æ”¯ä»˜' || order.status === 'paid'}}"
      src="/images/å·²æ”¯ä»˜.png" 
      mode="aspectFit"
    />
    <!-- å¾…æ”¯ä»˜ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å¾…æ”¯ä»˜' || order.status === 'pending' || order.status === 'pending_payment'}}"
      src="/images/å¾…æ”¯ä»˜-copy.png" 
      mode="aspectFit"
    />
    <!-- å·²å…³é—­ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'closed' || order.status === 'å·²å…³é—­'}}"
      src="/images/å·²å…³é—­.png" 
      mode="aspectFit"
    />
    <!-- å·²å–æ¶ˆ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å·²å–æ¶ˆ' || order.status === 'canceled' || order.status === 'cancelled'}}"
      src="/images/å·²å–æ¶ˆ.png" 
      mode="aspectFit"
    />
    <!-- å·²é€€æ¬¾ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å·²é€€æ¬¾' || order.status === 'refunded'}}"
      src="/images/å·²é€€æ¬¾.png" 
      mode="aspectFit"
    />
    <!-- æ”¯ä»˜å¤±è´¥ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'æ”¯ä»˜å¤±è´¥' || order.status === 'failed' || order.status === 'payment_failed'}}"
      src="/images/æ”¯ä»˜å¤±è´¥.png" 
      mode="aspectFit"
    />
    <!-- å·²ç¡®è®¤ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å·²ç¡®è®¤' || order.status === 'confirmed'}}"
      src="/images/å·²ç¡®è®¤.png" 
      mode="aspectFit"
    />
    <!-- å¤„ç†ä¸­ -->
    <image 
      class="status-icon-img" 
      wx:elif="{{order.status === 'å¤„ç†ä¸­' || order.status === 'processing'}}"
      src="/images/å¤„ç†ä¸­.png" 
      mode="aspectFit"
    />
    <!-- å…¶ä»–çŠ¶æ€ -->
    <view class="status-icon" wx:else>
      <text>ğŸ“¦</text>
    </view>
    <view class="status-info">
      <view class="status-main">
        <text class="status-text">{{order.statusText || order.status}}</text>
        <text wx:if="{{order.priority}}" class="tag-priority">ä¼˜å…ˆ</text>
        <van-tag wx:if="{{order.afterSaleStatus === 'å¾…å”®å'}}" type="warning" plain size="small">å”®åä¸­</van-tag>
      </view>
      <text class="status-time">{{orderTime}}</text>
    </view>
    <text class="status-amount">Â¥{{order.total}}</text>
  </view>

  <!-- æ”¶è´§ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">æ”¶è´§ä¿¡æ¯</text>
    </view>
    <view class="card-body">
      <block wx:if="{{order.addressSnapshot}}">
        <view class="address-row">
          <text class="address-name">{{order.addressSnapshot.name}}</text>
          <text class="address-phone">{{order.addressSnapshot.phone}}</text>
        </view>
        <text class="address-detail">{{addressText || order.addressSnapshot.full || order.addressSnapshot.detail}}</text>
      </block>
      <block wx:else>
        <text class="empty">æš‚æ— æ”¶è´§ä¿¡æ¯</text>
      </block>
    </view>
  </view>

  <!-- å•†å“æ¸…å• -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">å•†å“æ¸…å•</text>
    </view>
    <view class="card-body">
      <view class="product-item" wx:for="{{order.items}}" wx:key="id" wx:for-item="product">
        <image class="product-img" src="{{product.image}}" mode="aspectFill"></image>
        <view class="product-info">
          <text class="product-name">{{product.name}}</text>
          <!-- è§„æ ¼æ ‡ç­¾ -->
          <view class="product-specs" wx:if="{{product.paramPairs.length > 0 || product.specsText}}">
            <text class="spec-tag" wx:for="{{product.paramPairs}}" wx:key="key" wx:for-item="param">{{param.value}}</text>
            <text class="spec-tag" wx:if="{{!product.paramPairs.length && product.specsText}}">{{product.specsText}}</text>
          </view>
          <view class="product-bottom">
            <text class="product-price">Â¥{{product.subtotal}}</text>
            <text class="product-qty">Ã—{{product.quantity}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¢å•ä¿¡æ¯ -->
  <view class="card">
    <view class="card-header">
      <text class="card-title">è®¢å•ä¿¡æ¯</text>
    </view>
    <view class="card-body info-list">
      <view class="info-row">
        <text class="info-label">è®¢å•ç¼–å·</text>
        <text class="info-value" selectable>{{order.id}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">ä¸‹å•æ—¶é—´</text>
        <text class="info-value">{{orderTime}}</text>
      </view>
      <view class="info-row">
        <text class="info-label">æ”¯ä»˜æ–¹å¼</text>
        <text class="info-value">{{order.payMethod || 'å¾®ä¿¡æ”¯ä»˜'}}</text>
      </view>
    </view>
  </view>

  <!-- è™šæ‹Ÿå‘è´§ä¿¡æ¯å¡ç‰‡ï¼ˆä»…å·²æ”¯ä»˜çš„è™šæ‹Ÿå•†å“æ˜¾ç¤ºï¼šå·¥å…·åŒ…/è¯¾ç¨‹ï¼‰ -->
  <view class="card virtual-delivery-card" wx:if="{{showVirtualDelivery && virtualDeliveryInfo}}">
    <view class="virtual-delivery-header">
      <text class="card-title">{{virtualDeliveryInfo.title || 'è™šæ‹Ÿå‘è´§ä¿¡æ¯'}}</text>
      <view class="virtual-delivery-tag">å·²å‘è´§</view>
    </view>
    <view class="virtual-delivery-content">
      <text class="virtual-delivery-text">{{virtualDeliveryInfo.content}}</text>
      <view class="virtual-delivery-link-row">
        <text class="virtual-delivery-label">{{virtualDeliveryInfo.linkLabel || 'é“¾æ¥'}}ï¼š</text>
        <text class="virtual-delivery-link" selectable="true">{{virtualDeliveryInfo.link}}</text>
      </view>
      <view class="virtual-delivery-code-row">
        <text class="virtual-delivery-label">{{virtualDeliveryInfo.codeLabel || 'æå–ç '}}ï¼š</text>
        <text class="virtual-delivery-code">{{virtualDeliveryInfo.extractCode}}</text>
      </view>
      <text class="virtual-delivery-alt">{{virtualDeliveryInfo.altContact}}</text>
    </view>
    <button class="virtual-delivery-copy-btn" bindtap="onCopyVirtualDelivery">ä¸€é”®å¤åˆ¶</button>
  </view>

  <!-- é€€æ¬¾ä¿¡æ¯å¡ç‰‡ï¼ˆæœ‰é€€æ¬¾è®°å½•æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="card refund-card" wx:if="{{refundInfo}}" bindtap="onViewRefund">
    <view class="card-header refund-header">
      <text class="card-icon">ğŸ“</text>
      <text class="card-title">å”®åè¿›åº¦</text>
      <view class="refund-status">
        <text>{{refundInfo.status}}</text>
        <van-icon name="arrow" size="14px" color="#fa8c16"/>
      </view>
    </view>
    <view class="card-body">
      <text class="refund-type">{{refundInfo.refundTypeLabel}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="action-bar">
    <!-- ç¡®è®¤æ”¶è´§æŒ‰é’®ï¼ˆä»…å·²å‘è´§çŠ¶æ€æ˜¾ç¤ºï¼‰ -->
    <button 
      wx:if="{{order.status === 'shipped' || order.status === 'å·²å‘è´§'}}"
      class="btn primary" 
      bindtap="onConfirmReceive"
    >ç¡®è®¤æ”¶è´§</button>
    
    <button 
      wx:if="{{canApplyRefund}}"
      class="btn warning" 
      bindtap="onApplyRefund"
    >{{refundInfo.status === 'é€€æ¬¾å¤±è´¥' ? 'é‡æ–°ç”³è¯·é€€æ¬¾' : 'ç”³è¯·é€€è´§'}}</button>
    
    <button 
      wx:if="{{canCancel}}"
      class="btn" 
      bindtap="onCancel"
    >æ’¤é”€è®¢å•</button>
    
    <button 
      class="btn" 
      bindtap="onModify" 
      disabled="{{!canModify}}"
    >ä¿®æ”¹è®¢å•</button>
    
    <button class="btn" bindtap="onContact">è”ç³»å®¢æœ</button>
    
    <button 
      class="btn" 
      bindtap="onDelete" 
      wx:if="{{order.status==='canceled' || order.status==='cancelled' || order.status==='å·²å–æ¶ˆ' || order.status==='completed' || order.status==='å·²å®Œæˆ' || order.status==='refunded' || order.status==='å·²é€€æ¬¾' || order.status==='failed' || order.status==='payment_failed' || order.status==='æ”¯ä»˜å¤±è´¥' || order.status==='closed' || order.status==='å·²å…³é—­'}}"
    >åˆ é™¤è®¢å•</button>
  </view>

  <view class="bottom-spacer"></view>
</scroll-view>

<!-- é€€æ¬¾ç±»å‹é€‰æ‹© ActionSheet -->
<van-action-sheet
  show="{{showRefundSheet}}"
  actions="{{refundActions}}"
  bind:close="onCloseRefundSheet"
  bind:select="onSelectRefundType"
  cancel-text="å–æ¶ˆ"
  description="è¯·é€‰æ‹©é€€æ¬¾ç±»å‹"
  close-on-click-overlay
/>

