<scroll-view class="page" scroll-y>
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'submit' ? 'active' : ''}}" bindtap="switchTab" data-tab="submit">
      <text>æäº¤åé¦ˆ</text>
    </view>
    <view class="tab {{activeTab === 'history' ? 'active' : ''}}" bindtap="switchTab" data-tab="history">
      <text>å†å²è®°å½•</text>
      <view wx:if="{{unreadCount > 0}}" class="badge">{{unreadCount}}</view>
    </view>
  </view>

  <!-- æäº¤åé¦ˆè¡¨å• -->
  <view wx:if="{{activeTab === 'submit'}}" class="form-container">
    <view class="header">
      <text class="title">æä¾›åé¦ˆæ„è§</text>
      <text class="subtitle">æ‚¨çš„å»ºè®®å°†å¸®åŠ©æˆ‘ä»¬ä¸æ–­æ”¹è¿›</text>
    </view>

    <!-- åé¦ˆç±»å‹é€‰æ‹© -->
    <view class="section">
      <text class="section-title">åé¦ˆç±»å‹</text>
      <view class="type-list">
        <view 
          wx:for="{{feedbackTypes}}" 
          wx:key="value"
          class="type-item {{form.type === item.value ? 'selected' : ''}}"
          bindtap="selectType"
          data-type="{{item.value}}"
        >
          <text class="type-icon">{{item.icon}}</text>
          <text class="type-label">{{item.label}}</text>
        </view>
      </view>
    </view>

    <!-- åé¦ˆå†…å®¹ -->
    <view class="section">
      <text class="section-title">åé¦ˆå†…å®¹ <text class="required">*</text></text>
      <view class="textarea-wrapper">
        <textarea 
          class="textarea" 
          placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®...ï¼ˆæœ€å¤š500å­—ï¼‰" 
          maxlength="500"
          value="{{form.content}}"
          bindinput="onContentInput"
        />
        <text class="word-count">{{form.content.length}}/500</text>
      </view>
    </view>

    <!-- å›¾ç‰‡ä¸Šä¼  -->
    <view class="section">
      <text class="section-title">ä¸Šä¼ å›¾ç‰‡ <text class="optional">ï¼ˆå¯é€‰ï¼Œæœ€å¤š9å¼ ï¼‰</text></text>
      <view class="image-list">
        <view wx:for="{{form.images}}" wx:key="index" class="image-item">
          <image class="preview-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-index="{{index}}"></image>
          <view class="remove-btn" catchtap="removeImage" data-index="{{index}}">Ã—</view>
        </view>
        <view wx:if="{{form.images.length < 9}}" class="add-image" bindtap="chooseImage">
          <text class="add-icon">+</text>
          <text class="add-text">æ·»åŠ å›¾ç‰‡</text>
        </view>
      </view>
    </view>

    <!-- è”ç³»æ–¹å¼ -->
    <view class="section">
      <text class="section-title">è”ç³»æ–¹å¼ <text class="optional">ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿æˆ‘ä»¬è”ç³»æ‚¨ï¼‰</text></text>
      <input 
        class="input" 
        placeholder="æ‰‹æœºå·æˆ–å¾®ä¿¡å·" 
        value="{{form.contact}}"
        bindinput="onContactInput"
      />
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button class="submit-btn {{submitting ? 'disabled' : ''}}" bindtap="submit" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤åé¦ˆ'}}
    </button>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:if="{{activeTab === 'history'}}" class="history-container">
    <view wx:if="{{loading}}" class="loading">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <view wx:elif="{{historyList.length === 0}}" class="empty">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">æš‚æ— åé¦ˆè®°å½•</text>
    </view>

    <view wx:else class="history-list">
      <view 
        wx:for="{{historyList}}" 
        wx:key="_id" 
        class="history-item {{item.hasReply && !item.isRead ? 'unread' : ''}}"
        bindtap="viewDetail"
        data-id="{{item._id}}"
      >
        <view class="item-header">
          <text class="item-type">{{item.typeLabel}}</text>
          <text class="item-status status-{{item.status}}">{{item.statusLabel}}</text>
        </view>
        <text class="item-content">{{item.content}}</text>
        <view class="item-footer">
          <text class="item-time">{{item.createdAtText}}</text>
          <view wx:if="{{item.hasReply && !item.isRead}}" class="new-reply">æœ‰æ–°å›å¤</view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && historyList.length > 0}}" class="load-more" bindtap="loadMore">
      <text>{{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
    </view>
  </view>

  <!-- åé¦ˆè¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showDetail}}" class="detail-modal" catchtap="closeDetail">
    <view class="detail-content" catchtap="noop">
      <view class="detail-header">
        <text class="detail-title">åé¦ˆè¯¦æƒ…</text>
        <text class="close-btn" bindtap="closeDetail">Ã—</text>
      </view>
      
      <scroll-view class="detail-body" scroll-y>
        <view class="detail-section">
          <text class="detail-label">åé¦ˆç¼–å·</text>
          <text class="detail-value">{{currentDetail.feedbackNo}}</text>
        </view>
        
        <view class="detail-section">
          <text class="detail-label">åé¦ˆç±»å‹</text>
          <text class="detail-value">{{currentDetail.typeLabel}}</text>
        </view>
        
        <view class="detail-section">
          <text class="detail-label">åé¦ˆå†…å®¹</text>
          <text class="detail-value content">{{currentDetail.content}}</text>
        </view>
        
        <view wx:if="{{currentDetail.imageUrls && currentDetail.imageUrls.length > 0}}" class="detail-section">
          <text class="detail-label">å›¾ç‰‡</text>
          <view class="detail-images">
            <image 
              wx:for="{{currentDetail.imageUrls}}" 
              wx:key="index" 
              class="detail-image" 
              src="{{item}}" 
              mode="aspectFill"
              bindtap="previewDetailImage"
              data-index="{{index}}"
            ></image>
          </view>
        </view>
        
        <view class="detail-section">
          <text class="detail-label">çŠ¶æ€</text>
          <text class="detail-value status-{{currentDetail.status}}">{{currentDetail.statusLabel}}</text>
        </view>
        
        <view class="detail-section">
          <text class="detail-label">æäº¤æ—¶é—´</text>
          <text class="detail-value">{{currentDetail.createdAtText}}</text>
        </view>
        
        <view wx:if="{{currentDetail.reply}}" class="detail-section reply-section">
          <text class="detail-label">å®˜æ–¹å›å¤</text>
          <view class="reply-box">
            <text class="reply-content">{{currentDetail.reply}}</text>
            <text class="reply-time">{{currentDetail.replyTimeText}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</scroll-view>
