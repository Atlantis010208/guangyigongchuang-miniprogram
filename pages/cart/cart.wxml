<!--è´­ç‰©è¢‹é¡µé¢-->
<view class="page">
  <!-- æœªç™»å½•æç¤º -->
  <view wx:if="{{!isLoggedIn}}" class="login-prompt">
    <view class="login-prompt-content">
      <image class="login-prompt-icon" src="../../images/cart.png" mode="aspectFit"></image>
      <text class="login-prompt-title">ç™»å½•åæŸ¥çœ‹è®¢å•</text>
      <text class="login-prompt-desc">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ç…§æ˜æ–¹æ¡ˆè®¢å•å’Œå•†åŸè®¢å•</text>
      <button class="login-prompt-btn" bindtap="onGoLogin">ç«‹å³ç™»å½•</button>
      <text class="login-prompt-tip">æ‚¨ä¹Ÿå¯ä»¥å…ˆæµè§ˆå…¶ä»–åŠŸèƒ½</text>
    </view>
  </view>

  <!-- å·²ç™»å½•æ˜¾ç¤ºæ­£å¸¸å†…å®¹ -->
  <block wx:if="{{isLoggedIn}}">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header">
      <text class="page-title">ç¯å…‰æ¸…å•</text>
      <view wx:if="{{cartItems.length > 0}}" class="edit-btn" bindtap="onEditTap">
        <text class="edit-text">{{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
      </view>
    </view>

    <!-- ç­›é€‰å™¨ï¼šå•†åŸè®¢å• / æ–¹æ¡ˆè®¢å• -->
    <view class="filters">
    <scroll-view class="filter-scroll" scroll-x>
      <view class="filter-chip {{filterType==='mall' ? 'active' : ''}}" data-type="mall" bindtap="onFilterTap">ç”µå­å•†åŸ ({{mallOrders.length || 0}})</view>
      <view class="filter-chip {{filterType==='scheme' ? 'active' : ''}}" data-type="scheme" bindtap="onFilterTap">æ–¹æ¡ˆè®¢å• ({{requests.length || 0}})</view>
    </scroll-view>
  </view>

  <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
  <view wx:if="{{cartItems.length > 0}}" class="cart-content">
    <!-- å•†å“åˆ—è¡¨ -->
    <view class="cart-items">
      <view wx:for="{{cartItems}}" wx:key="id" class="cart-item">
        <!-- é€‰æ‹©æ¡† -->
        <view wx:if="{{isEditing}}" class="checkbox" bindtap="onSelectItem" data-id="{{item.id}}">
          <image wx:if="{{item.selected}}" class="checkbox-icon" src="../../images/checkbox-checked.png" mode="aspectFit"></image>
          <view wx:else class="checkbox-empty"></view>
        </view>

        <!-- å•†å“ä¿¡æ¯ -->
        <view class="item-content">
          <image class="item-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-title">{{item.title}}</text>
            <text class="item-specs">{{item.specs}}</text>
            <text class="item-price">{{item.price}}</text>
            
            <!-- æ•°é‡æ§åˆ¶ -->
            <view wx:if="{{!isEditing}}" class="quantity-control">
              <view class="quantity-btn {{item.quantity <= 1 ? 'disabled' : ''}}" bindtap="onDecreaseQuantity" data-id="{{item.id}}">
                <text class="quantity-btn-text">-</text>
              </view>
              <text class="quantity-text">{{item.quantity}}</text>
              <view class="quantity-btn" bindtap="onIncreaseQuantity" data-id="{{item.id}}">
                <text class="quantity-btn-text">+</text>
              </view>
            </view>

            <!-- ç¼–è¾‘çŠ¶æ€ä¸‹çš„æ“ä½œ -->
            <view wx:if="{{isEditing}}" class="edit-actions">
              <view class="action-btn" bindtap="onSaveForLater" data-id="{{item.id}}">
                <text class="action-text">ç¨åè´­ä¹°</text>
              </view>
              <view class="action-btn delete" bindtap="onDeleteItem" data-id="{{item.id}}">
                <text class="action-text">åˆ é™¤</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¨åè´­ä¹° -->
    <view wx:if="{{savedItems.length > 0}}" class="saved-section">
      <view class="saved-header" bindtap="onToggleSaved">
        <text class="saved-title">ç¨åè´­ä¹° ({{savedItems.length}})</text>
        <text class="toggle-icon">{{showSaved ? 'ï¸½' : 'ï¸¾'}}</text>
      </view>
      
      <view wx:if="{{showSaved}}" class="saved-items">
        <view wx:for="{{savedItems}}" wx:key="id" class="saved-item">
          <image class="saved-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="saved-info">
            <text class="saved-title">{{item.title}}</text>
            <text class="saved-specs">{{item.specs}}</text>
            <text class="saved-price">{{item.price}}</text>
          </view>
          <view class="saved-actions">
            <view class="saved-btn" bindtap="onMoveToCart" data-id="{{item.id}}">
              <text class="saved-btn-text">ç§»åˆ°è´­ç‰©è¢‹</text>
            </view>
            <view class="saved-btn delete" bindtap="onDeleteSaved" data-id="{{item.id}}">
              <text class="saved-btn-text">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ¨èå•†å“ -->
    <view class="recommendations">
      <text class="recommendations-title">ä½ å¯èƒ½è¿˜å–œæ¬¢</text>
      <scroll-view class="recommendations-scroll" scroll-x>
        <view class="recommendations-container">
          <view wx:for="{{recommendations}}" wx:key="id" class="recommendation-item" bindtap="onRecommendationTap" data-item="{{item}}">
            <image class="recommendation-image" src="{{item.image}}" mode="aspectFill"></image>
            <text class="recommendation-title">{{item.title}}</text>
            <text class="recommendation-price">{{item.price}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å‘å¸ƒçš„ç…§æ˜éœ€æ±‚åˆ—è¡¨ -->
  <view class="cart-content" wx:if="{{filterType==='scheme' && requests.length > 0}}">
    <view class="cart-items">
      <view class="cart-item" wx:for="{{requests}}" wx:key="id" bindtap="onRequestTap" data-id="{{item.id}}">
        <view class="item-content">
          <image class="item-image" src="{{item.cover}}" mode="aspectFill"></image>
          <view class="item-info">
            <text class="item-title">{{item.cardTitle || item.space || 'ç…§æ˜éœ€æ±‚'}} <text wx:if="{{item.status==='canceled'}}" class="tag-cancel">å·²æ’¤é”€</text><text wx:elif="{{item.statusText}}" class="tag-status">{{item.statusText}}</text><text wx:if="{{item.priority}}" class="tag-priority">ä¼˜å…ˆ</text></text>
            <text wx:if="{{item.source==='publish'}}" class="item-specs">é¢ç§¯ {{item.area || '-'}}ã¡ Â· é¢„ç®— Â¥{{item.budget || '-'}} Â· ä¸»ç¯ {{item.mainLight || '-'}} Â· é£æ ¼ {{item.style || '-'}} </text>
            <text wx:elif="{{item.category==='custom'}}" class="item-specs">{{item.area || '-'}}ã¡ Â· {{item.budget || '-'}} Â· {{item.style || '-'}} Â· {{item.progress || '-'}}</text>
            <!-- ğŸ”¥ é€‰é…æœåŠ¡ï¼šä¸å…¶ä»–è®¢å•ä¿æŒä¸€è‡´çš„å•è¡Œå¸ƒå±€ -->
            <text wx:elif="{{item.category==='selection'}}" class="item-specs">é¢„ç®— Â¥{{item.budget || '-'}} Â· {{item.stage || 'æœªå¼€å·¥'}}{{item.ceilingDrop ? ' Â· åŠé¡¶' + item.ceilingDrop : ''}}{{item.bodyHeight ? ' Â· ç¯ä½“' + item.bodyHeight : ''}}</text>
            <text wx:elif="{{item.source==='scheme'}}" class="item-specs">ç±»åˆ«ï¼š{{item.categoryCN || item.category || '-'}}</text>
            <text wx:elif="{{item.source==='optimize'}}" class="item-specs">æ–¹æ¡ˆä¼˜åŒ–æœåŠ¡</text>
            <text wx:elif="{{item.source==='full'}}" class="item-specs">æ•´å¥—è®¾è®¡æœåŠ¡</text>
            <text wx:elif="{{item.source==='custom_form'}}" class="item-specs">ä¸ªæ€§éœ€æ±‚å®šåˆ¶</text>
            <!-- ğŸ”¥ è®¾è®¡å¸ˆçŠ¶æ€åŒºåŸŸ -->
            <view class="designer-status-row">
              <block wx:if="{{item.designerStatus === 'assigned'}}">
                <!-- å·²åˆ†é…ï¼šæ˜¾ç¤ºè®¾è®¡å¸ˆåå­— -->
                <view class="designer-assigned">
                  <text class="designer-label">è®¾è®¡å¸ˆï¼š</text>
                  <text class="designer-name">{{item.designerName}}</text>
                </view>
              </block>
              <block wx:elif="{{item.designerStatus === 'pending'}}">
                <!-- å¾…ç¡®è®¤ï¼šå·²é¢„çº¦ä½†è®¾è®¡å¸ˆæœªç¡®è®¤ -->
                <view class="designer-pending">
                  <text class="designer-label">è®¾è®¡å¸ˆï¼š</text>
                  <text class="designer-status-pending">å¾…ç¡®è®¤</text>
                </view>
              </block>
              <block wx:else>
                <!-- æœªé¢„çº¦ï¼šæ˜¾ç¤ºç­›é€‰æŒ‰é’® -->
                <button class="mini-btn designer-btn" size="mini" data-request="{{item}}" catchtap="onGoToDesigners">è®¾è®¡å¸ˆç­›é€‰</button>
              </block>
            </view>
          </view>
        </view>
        <view wx:if="{{item.status==='canceled'}}" class="request-delete" catchtap="onDeleteRequest" data-id="{{item.id}}"><text class="request-delete-text">Ã—</text></view>
      </view>
    </view>
  </view>

  <!-- å•†åŸè®¢å•åˆ—è¡¨ -->
  <view class="cart-content" wx:if="{{filterType==='mall' && mallOrders.length > 0}}">
    <view class="cart-items mall-order-list">
      <view class="cart-item mall-order-card" wx:for="{{mallOrders}}" wx:key="id">
        <!-- è®¢å•å¤´éƒ¨ï¼šæ ‡é¢˜å’ŒçŠ¶æ€ -->
        <view class="mall-order-header" bindtap="onMallOrderTap" data-id="{{item.id}}">
          <view class="mall-order-title-wrap">
            <text class="mall-order-title">{{item.title}}</text>
            <text class="mall-order-time">{{item.time}}</text>
          </view>
          <view class="mall-order-status-wrap">
            <van-tag wx:if="{{item.afterSaleStatus === 'å¾…å”®å'}}" type="warning" plain size="small">å”®åä¸­</van-tag>
            <van-tag wx:if="{{item.afterSaleStatus === 'å”®åå®Œæˆ'}}" type="success" plain size="small">å”®åå®Œæˆ</van-tag>
            <text class="mall-order-status status-{{item.statusType}}">{{item.status}}</text>
          </view>
        </view>
        
        <!-- è®¢å•å•†å“ä¿¡æ¯ -->
        <view class="mall-order-content" bindtap="onMallOrderTap" data-id="{{item.id}}">
          <image class="item-image" src="{{item.items[0].image}}" mode="aspectFill"></image>
          <view class="item-info">
            <view>
              <text class="item-specs">{{item.items[0].name}}</text>
              <text class="item-quantity" wx:if="{{item.items.length > 1}}">ç­‰ {{item.items.length}} ä»¶å•†å“</text>
              <text class="item-quantity" wx:else>Ã— {{item.items[0].quantity}}</text>
            </view>
            <text class="item-price">Â¥{{item.total}}</text>
          </view>
        </view>
        
        <!-- è®¢å•åº•éƒ¨ï¼šæ“ä½œæŒ‰é’®ï¼ˆå…¨é å³ï¼‰ -->
        <view class="mall-order-footer">
          <view class="mall-order-actions">
            <!-- åˆ é™¤æŒ‰é’®ï¼ˆä»…å·²å…³é—­/å·²é€€æ¬¾è®¢å•æ˜¾ç¤ºï¼‰ -->
            <view 
              wx:if="{{item.statusType==='closed' || item.statusType==='refunded'}}" 
              class="mini-btn detail-btn" 
              catchtap="onDeleteMallOrder" 
              data-id="{{item.id}}"
              style="margin-right: 0 !important;"
            >åˆ é™¤è®¢å•</view>
            
            <!-- è®¢å•è¯¦æƒ…æŒ‰é’® -->
            <button 
              class="mini-btn detail-btn" 
              size="mini"
              data-id="{{item.id}}" 
              catchtap="onMallOrderTap"
            >è¯¦æƒ…</button>
            
            <!-- å¾…æ”¯ä»˜è®¢å•æ˜¾ç¤ºå»æ”¯ä»˜æŒ‰é’® -->
            <button 
              wx:if="{{item.canPay}}" 
              class="mini-btn pay-btn" 
              size="mini"
              data-orderno="{{item.orderNo}}" 
              catchtap="onPayOrder"
            >å»æ”¯ä»˜</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ–¹æ¡ˆè®¢å•ç©ºçŠ¶æ€ -->
  <view wx:if="{{filterType==='scheme' && requests.length === 0}}" class="empty-cart">
    <image class="empty-icon" src="../../images/cart.png" mode="aspectFit"></image>
    <text class="empty-title strong">æš‚æ— æ–¹æ¡ˆè®¢å•</text>
    <text class="empty-subtitle center">å‘å¸ƒç…§æ˜éœ€æ±‚æˆ–æŸ¥çœ‹ä¸ªäººä¸­å¿ƒçš„è®¢å•ã€‚</text>
  </view>

  <!-- å•†åŸè®¢å•ç©ºçŠ¶æ€ -->
  <view wx:if="{{filterType==='mall' && mallOrders.length === 0}}" class="empty-cart">
    <image class="empty-icon" src="../../images/cart.png" mode="aspectFit"></image>
    <text class="empty-title strong">æš‚æ— å•†åŸè®¢å•</text>
    <text class="empty-subtitle center">å»ç”µå­å•†åŸæŒ‘é€‰å•†å“å¹¶ä¸‹å•å§ã€‚</text>
  </view>

  <!-- åº•éƒ¨ç»“ç®—æ  -->
  <view wx:if="{{cartItems.length > 0 && !isEditing}}" class="checkout-bar">
    <view class="total-section">
      <text class="total-label">å°è®¡ï¼š</text>
      <text class="total-price">{{totalPrice}}</text>
    </view>
    <view class="checkout-btn {{canCheckout ? '' : 'disabled'}}" bindtap="onCheckout">
      <text class="checkout-text">ç»“ç®—</text>
    </view>
  </view>

  <!-- ç¼–è¾‘æ¨¡å¼åº•éƒ¨æ  -->
  <view wx:if="{{isEditing && selectedItems.length > 0}}" class="edit-bar">
    <view class="selected-count">
      <text class="selected-text">å·²é€‰æ‹© {{selectedItems.length}} ä»¶å•†å“</text>
    </view>
    <view class="edit-actions-bar">
      <view class="edit-action-btn" bindtap="onBatchSaveForLater">
        <text class="edit-action-text">ç¨åè´­ä¹°</text>
      </view>
      <view class="edit-action-btn delete" bindtap="onBatchDelete">
        <text class="edit-action-text">åˆ é™¤</text>
      </view>
    </view>
  </view>
  </block>
</view>





