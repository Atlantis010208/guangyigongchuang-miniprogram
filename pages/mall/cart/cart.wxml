<wxs module="utils">
var isSelected = function(selectedIds, key) {
  if (!selectedIds || !key) return false;
  for (var i = 0; i < selectedIds.length; i++) {
    if (selectedIds[i] === key) return true;
  }
  return false;
};
module.exports = {
  isSelected: isSelected
};
</wxs>

<scroll-view class="page" scroll-y enable-back-to-top>
  <view class="header">
    <text class="title">购物车</text>
  </view>

  <!-- 加载中状态 -->
  <view wx:if="{{loading && items.length === 0}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 购物车列表 -->
  <view wx:elif="{{items.length > 0}}" class="list">
    <van-swipe-cell 
      right-width="{{ 65 }}" 
      wx:for="{{items}}" 
      wx:key="_key"
      class="swipe-cell-item"
    >
      <view class="row">
        <!-- 选择框 -->
        <view class="checkbox-wrapper" catchtap="stopBubble">
          <van-checkbox 
            value="{{utils.isSelected(selectedIds, item._key)}}" 
            bind:change="onToggleSelect" 
            data-key="{{item._key}}"
            checked-color="#000"
            icon-size="22px"
          />
        </view>
        
        <image class="cover" src="{{item.image}}" mode="aspectFill" bindtap="goDetail" data-id="{{item.id}}"></image>
        
        <view class="info">
          <view class="info-top">
            <text class="name">{{item.name}}</text>
            <text wx:if="{{item.specsText}}" class="specs">{{item.specsText}}</text>
          </view>
          <view class="info-bottom">
            <text class="price">¥{{item.price}}</text>
            <view class="qty">
              <view class="qty-btn minus" bindtap="dec" data-id="{{item.id}}">-</view>
              <text class="num">{{item.quantity || 1}}</text>
              <view class="qty-btn plus" bindtap="inc" data-id="{{item.id}}">+</view>
            </view>
          </view>
        </view>
      </view>
      
      <view slot="right" class="delete-btn" catchtap="remove" data-id="{{item.id}}">
        <text>删除</text>
      </view>
    </van-swipe-cell>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty">
    <image class="empty-icon" src="/images/购物车.png" mode="aspectFit"></image>
    <text class="empty-title">购物车是空的</text>
    <text class="empty-subtitle">去电子商城挑选商品并加入购物车吧</text>
    <button class="btn primary" bindtap="goMall">去商城</button>
  </view>
</scroll-view>

<!-- 悬浮联系客服按钮 -->
<view class="floating-contact" bindtap="onContact">
  <image class="float-icon" src="/images/客服.png" mode="aspectFit"></image>
  <text class="float-text">联系客服</text>
</view>

<!-- 提交订单栏 -->
<van-submit-bar
  wx:if="{{items.length > 0}}"
  price="{{ totalPrice }}"
  button-text="提交订单"
  bind:submit="onSubmit"
  button-class="submit-btn"
  bar-class="submit-bar"
>
  <van-checkbox 
    value="{{ allChecked }}" 
    bind:change="onToggleSelectAll"
    checked-color="#000"
    class="select-all-checkbox"
  >
    全选
  </van-checkbox>
</van-submit-bar>
