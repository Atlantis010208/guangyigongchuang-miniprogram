## 问题确认

* 错误：`cloud.callFunction:fail ... errCode: -504002 ... handler not found`，说明云函数未正确导出 `exports.main` 或未部署。

* 代码证据：`cloudfunctions/login/index.js` 为空；前端调用位置 `pages/auth/login/login.js:39-41` 明确要求存在名为 `login` 的云函数并返回 `{ success, openid, user }`。

* 环境不一致：小程序端初始化到 `cloud1-5gb9c5u2c58ad6d7`（`app.js:11-14`），而你的实际环境是 `cloud1-1gqerbbu347adc17`，将导致调用错误环境下的云函数。

## 修复方案

1. 实现并导出 `login` 云函数处理器：

   * 位置：`cloudfunctions/login/index.js`

   * 必须包含 `const cloud = require('wx-server-sdk')`、`cloud.init(...)` 与 `exports.main = async (event) => { ... }`。

   * 逻辑：通过 `cloud.getWXContext()` 获取 `OPENID`，在 `users` 集合中根据 `openid` upsert 用户档案，返回 `{ success: true, openid, user }`。
2. 统一环境为你的实际环境：

   * 小程序端：将 `app.js:11-14` 的 `env` 改为 `cloud1-1gqerbbu347adc17`（或使用项目绑定环境自动选择）。

   * 云函数端：`cloud.init({ env: 'cloud1-1gqerbbu347adc17' })`；或省略 `env` 让其默认使用部署环境，避免硬编码。
3. 在微信开发者工具中部署：

   * 打开“云开发→云函数”，选择 `login`；点击“安装依赖”，再“上传并部署（云端安装依赖）”。

   * 若看不到 `login`，新建云函数并指向 `cloudfunctions/login` 目录。
4. 快速自测：

   * 在云函数“测试”面板传入 `{ "profile": { "nickName": "Test", "avatarUrl": "" } }`，确认返回含 `success/openid/user`。

   * 前端点击“授权并登录”，观察本地存储出现 `openid` 与 `userDoc`，并跳转到 `/pages/auth/profile-edit/profile-edit`。

## 代码示例（用于实现）

* 云函数 `cloudfunctions/login/index.js`：

```
const cloud = require('wx-server-sdk')
cloud.init({ env: 'cloud1-1gqerbbu347adc17' })
exports.main = async (event) => {
  const db = cloud.database()
  const { OPENID } = cloud.getWXContext()
  const profile = (event && event.profile) || {}
  const users = db.collection('users')
  const now = Date.now()
  const found = await users.where({ openid: OPENID }).get()
  let user
  if (!found.data || found.data.length === 0) {
    const addRes = await users.add({ data: { openid: OPENID, nickName: profile.nickName || '', avatarUrl: profile.avatarUrl || '', createdAt: now, updatedAt: now } })
    user = { _id: addRes._id, openid: OPENID, nickName: profile.nickName || '', avatarUrl: profile.avatarUrl || '' }
  } else {
    const id = found.data[0]._id
    await users.doc(id).update({ data: { nickName: profile.nickName || found.data[0].nickName || '', avatarUrl: profile.avatarUrl || found.data[0].avatarUrl || '', updatedAt: now } })
    user = await users.doc(id).get().then(r => r.data)
  }
  return { success: true, openid: OPENID, user }
}
```

## 验证与回归

* 登录页触发后显示“登录成功”，`wx.setStorageSync('openid')` 与 `wx.setStorageSync('userDoc')` 写入生效（`pages/auth/login/login.js:44-47`）。

* 云数据库 `users` 集合产生/更新记录；拒绝授权时前端仍能给出明确提示。

确认后，我将：

* 补全并导出 `login` 云函数。

* 将前端 `wx.cloud.init` 切到你的环境或改为自动绑定。

* 部署并完成端到端验证，确保登录流程恢复。

