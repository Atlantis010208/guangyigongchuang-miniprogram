# 项目概览

- 项目为原生微信小程序，已启用云开发，核心依赖云数据库与云函数，未发现前端管理后台。
- 云环境：`cloud1-1gqerbbu347adc17`（app.js:12、cloudfunctions/login/index.js:3）。入口与配置完整（app.json:136、project.config.json:84-85）。
- 数据访问封装集中于 `utils/api.js` 提供仓库（users/orders/requests/designers/appointments）（utils/api.js:15-63）。
- 典型链路：登录与资料（pages/auth/login/login.js:39-47）、集合初始化（app.js:101-121）、订单与请求的逻辑删除（utils/api.js:33、41）。
- 后端形态：
  - 云函数：登录、手机号、集合初始化、设计师/预约等（cloudfunctions/*）。
  - 云托管：Express 占位服务（推荐、支付回调）（cloudrun/index.js:5-14），暂未与前端集成。

## 关键架构判断

- 前端以云开发为主，不使用 `wx.request` 直连第三方；服务写操作与鉴权通过云函数执行。
- 数据模型清晰：`users/orders/requests/...`，删除策略为逻辑删除（`isDelete`）。
- 管理后台不存在（未发现 `admin/cms/panel` 目录），需要单独规划或采用微信云托管 + 控制台代管。

## 开发顺序建议

- 优先级1：完善后端基础能力（云函数与云托管）
  - 加固鉴权与用户模型：完善 `login`、`getPhoneNumber` 返回结构与异常（cloudfunctions/login/index.js:57-60、cloudfunctions/getPhoneNumber/index.js:11-15）；统一前端缓存策略（pages/auth/login/login.js:44-47）。
  - 集合治理：确保 `initCollections` 覆盖所有集合并加索引；前端初始化版本位（app.js:106-121）。
  - 统一数据访问：核对并补齐 `utils/api.js` 仓库的过滤与分页、`isDelete` 读写一致性（utils/api.js:29-35、41-45）。
  - 云托管服务实化：将 `cloudrun` 的推荐与支付回调从占位改为可用，并与小程序对接（cloudrun/index.js:5-14）。
- 优先级2：上线前的监控与弹性
  - 云托管日志、灰度与告警规则按环境配置（Context7 引用见下）。
- 优先级3：管理后台（独立项目）
  - 在后端接口稳定后再建设管理端（商品/分类/设计师/预约/交易/通知等），建议基于云托管 + 任意前端框架，或先用微信控制台与集合权限代管作为过渡。

## 近期任务清单（示例）

- 加固登录/手机号云函数的错误处理与返回字段一致性。
- 完整化 `initCollections` 与集合索引/权限模板；前端初始化版本标记与重试策略核验。
- 统一 `orders/requests` 双写与逻辑删除的过滤规则；补齐列表分页与监听退避。
- 云托管 `recommend/pay` 接口落地，并设计与小程序的调用契约；支付回调按微信规范对接。
- 规划管理后台的域模型与接口（后端优先、管理端次之）。

## Context7 依据（已选择文档库）

- 选定：`/websites/developers_weixin_qq_miniprogram_dev_wxcloudservice_wxcloudrun_src`（微信云托管官方文档）。
  - 云托管 vs 云函数：云托管为高阶版本，语言框架自由、常驻运行、单实例多并发、支持多维灰度（来源：Cloud Run 概览，对比节）。
  - 支付回调与退款参数：回调可选择云函数或云托管，包含 `container.service/path` 等字段（来源：支付退款章节）。
  - 多环境流水线建议：开发/测试与预发/生产的分支、触发、实例规格、灰度发布（来源：多环境实践章节）。
  - 告警规则：环境与计费相关提醒配置（来源：告警设置章节）。
- 说明：通用框架与 API 文档库 `/websites/developers_weixin_qq_miniprogram` 存取受限时，以云托管文档作为可检索依据；后续如需补充组件/API细则，可继续调用。

## 结论与执行路径

- 先开发后端（云函数与云托管），确保鉴权、数据模型与接口契约稳定；随后再建设管理后台。
- 选择云托管承载面向运营/管理的服务与支付回调，云函数承载鉴权与敏感写，前端继续通过仓库层访问数据库与云函数。
- 完成上述后端与数据治理再进入管理端 UI 与运营工具开发，以降低返工与接口变更风险。

## 验证与交付

- 以小程序端登录、集合初始化、订单/请求写删与监听作为集成验收；云托管接口联调与支付回调沙箱验证；集合权限与索引检查通过微信开发者工具与控制台。