# 概述
- 目标：全面移除前端模拟数据，改为后端调用云函数与云数据库/云存储，并按需引入云托管以承载长驻后端服务。
- 已检索代码结构并定位模拟数据与云开发使用点；后续按清单实施替换、补齐后端能力与权限、部署与验证。
- 参考文档（Context7）：
  - 云开发总览与能力：`/websites/developers_weixin_qq_miniprogram_dev_wxcloudservice_wxcloud`
  - 云托管总览与部署：`/websites/developers_weixin_qq_miniprogram_dev_wxcloudservice_wxcloudrun_src`

# 现状与改造范围
- 云初始化：`app.js:11-15` 使用 `wx.cloud.init({ env: 'cloud1-1gqerbbu347adc17' })`
- 数据访问封装：`utils/api.js:10-13,15-47` 已封装 `users/orders/requests` 仓库与 `watch` 实时监听
- 现有云函数：
  - 登录：`cloudfunctions/login/index.js:5-12,57-61`，创建/更新 `users` 集合
  - 集合初始化：`cloudfunctions/initCollections/index.js:18-31`，创建 `users/orders/requests/products/categories/transactions/notifications/surveys`
  - 获取手机号：`cloudfunctions/getPhoneNumber/index.js`
- 模拟数据：
  - 设计师列表：`pages/designers/list/list.js:35-41,44-101`
  - 设计师详情：`pages/designers/detail/detail.js:47-54,56-81`
- 本地缓存数据：购物/需求等大量使用 `wx.setStorageSync/ getStorageSync`，需逐步云端化：如 `pages/cart/cart.js:267-310,312-375`

# 任务清单
## 一、移除模拟数据并接入云端
- 删除 `pages/designers/list/list.js` 与 `pages/designers/detail/detail.js` 的模拟数据来源，改为云数据库或云函数查询
- 建立 `designers` 集合（字段示例：`name,title,avatarUrl,portfolioLayout,images,ratings,projectCount,pricePerSqm,hasCalcExperience,introduction,qualifications,cases`）
- 新增云函数：
  - `designers_list`：支持筛选与分页（空间类型 `spaceType`、评分阈值 `minRating`、排序 `rating/projects/price`）
  - `designer_detail`：按 `_id` 返回详情（含案例与评价）
- 前端调用改造：
  - 列表：`wx.cloud.callFunction({ name: 'designers_list', data: { filters, sortBy, page } })`
  - 详情：`wx.cloud.callFunction({ name: 'designer_detail', data: { id } })`

## 二、需求与预约云端化
- 设计师预约：将 `pages/designers/detail/detail.js:184-199` 注释的云端保存改造为真实写入，落库到 `appointments` 集合（权限：仅创建者可读写）
- 新增云函数：
  - `appointments_create`：校验与写入（注入 `_openid`，自动可信鉴权）
  - `appointments_list_by_user`：分页查询用户预约
  - `appointments_cancel`：状态流转与审计字段

## 三、订单与需求数据双轨合并与云端对齐
- 对齐本地与云端合并逻辑：`pages/cart/cart.js:292-308`，以云端为主、本地为辅
- 扩充 `orders`、`requests` 集合字段（`isDelete,status,category,params,orderNo,createdAt,updatedAt`）与索引（`userId,orderNo,createdAt`）
- 云函数补齐：
  - `orders_list_by_user`、`orders_update_by_orderNo`（逻辑删除同 `cart.js:344-349`）
  - `requests_list_by_user`、`requests_update`（含 `watch` 兼容）

## 四、云数据库权限与安全
- 配置集合权限（参考 Context7 权限：基础权限设置）
  - `products/categories/designers`：仅管理端可写，所有人可读
  - `users/orders/requests/appointments/transactions/notifications/surveys`：仅创建者可读写（或业务需要下细分）
- 云函数使用 `getWXContext` 获取可信身份（参考：`/wxcloud/guide/functions/userinfo`）
- 统一错误码与重试策略（参考：云资源通用错误码）

## 五、云存储接入与图片链接管理
- 将本地静态图片统一迁移到云存储，前端通过 `wx.cloud.getTempFileURL` 获取临时链接（示例见 `pages/profile/favorites` 与 `toolkit-detail` 类似用法）
- 设置 CDN 缓存策略与监控（参考文档：存储管理与缓存配置、监控图表）

## 六、云托管后端（按需）
- 场景：推荐/计算任务、支付回调、第三方集成或需常驻进程
- 创建 Node.js 云托管服务（支持 `cloud.callContainer` 调用），初期提供 REST 接口：
  - `/api/recommend/designers`：基于用户偏好与案例标签的推荐
  - `/api/pay/callback`：支付结果通知（参考云托管支付回调文档）
- 部署与灰度：按云托管流程（支持流水线与定向灰度发布）

## 七、前端数据访问层统一
- 在 `utils/api.js` 扩展仓库：新增 `getDesignersRepo(getAppointmentsRepo)`，保持与现有仓库同风格
- 将页面直接数据库调用与云函数调用进行分层封装，前端页面仅依赖仓库/服务层，便于后续迁移与测试

## 八、环境与配置
- `project.config.json` 保持 `cloudfunctionRoot` 与预览页设置；如需新增云函数目录按同规范追加
- `app.js` 中保留 `initCollectionsIfDev` 的集合检测与自动初始化逻辑；上线阶段可切换为运维脚本
- 规范 `env` 与资源配额（云开发环境、存储、数据库读写与监听上限）

## 九、索引与性能优化
- 为高频查询字段建立索引：`orders(userId,orderNo,createdAt)`、`requests(userId,createdAt,status)`、`designers(rating,projectCount,pricePerSqm)`
- 使用聚合与 Explain 优化查询（参考：聚合流水线与 Explain）

## 十、监控与日志
- 云函数调用次数/错误次数监控与导出
- 云托管服务日志检索（全文/模糊/键值检索语法）
- 业务事件与告警配置（失败率、超时、配额触发）

## 十一、测试与验证
- 前端页面替换后的功能回归：
  - 设计师列表/详情展示与筛选
  - 预约创建与查询
  - 购物车云端实时监听与本地合并
- 云函数单元测试（DevTools 端调试与日志验证）与云托管接口集成测试

## 十二、迁移与数据治理
- 将历史本地缓存（如 `lighting_requests`、`mall_orders`、`designer_appointments`）逐步迁移至云端集合；上线后清理本地冗余
- 导出/备份策略与回滚预案（云控制台导出功能）

# 交付物
- 任务清单与改造说明（MD 文档内容即本清单）
- 新增云函数：`designers_list`、`designer_detail`、`appointments_*`、`orders_*`、`requests_*`
- 集合与权限规则：`users/orders/requests/products/categories/transactions/notifications/surveys/appointments/designers`
- 云托管服务（如需）：`/api/recommend/designers`、`/api/pay/callback`

# 参考（Context7 摘要）
- 云函数管理与用户态：支持天然鉴权与 `OPENID/APPID` 注入；DevTools 中右键管理云函数（创建/下载/对比/部署）
- 数据库权限：仅创建者可读写/仅管理端可写等基础权限模型（`_openid` 自动注入）
- 实时推送：单次监听上限 5000 条，支持 `where/orderBy/limit`，权限同样生效
- 存储与缓存：合理配置 CDN 缓存时长与策略优先级，监控上传/下载/CDN 流量
- 云托管：天然鉴权、任意语言、自动扩缩、灰度发布、CI/CD 流水线，接口调用支持 `cloud.callContainer`

# 下一步
- 按上述清单实施文件级改造：删除模拟数据函数，接入仓库/云函数调用；创建/补齐集合与索引；配置权限；编写与部署云函数；可选创建云托管服务；完成监控与测试。