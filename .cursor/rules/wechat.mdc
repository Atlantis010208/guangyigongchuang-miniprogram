---
alwaysApply: true
---
# 项目规则：微信小程序 + 微信云开发

本项目使用 **微信小程序 + 微信云开发（CloudBase）**：
- 前端：微信小程序（wxml / wxss / js / json）
- 后端：云函数（Node.js + 云数据库）
- 数据库：微信云开发云数据库（MongoDB 风格）

Cursor 在本仓库中写代码时，请**严格遵守以下规则**。


## 通用开发规范
- 所有代码和注释统一使用**简体中文**描述业务逻辑，变量 / 函数 / 文件名使用**有语义的英文**。
- 尽量使用 **async/await**，不要再使用 Promise then 回调地狱。
- 对外导出的函数、复杂业务逻辑，必须写清晰的注释（说明入参、返回值和异常情况）。
- 优先保持与项目现有代码风格一致（命名风格、文件结构、工具函数等）。
- 如果不确定某个微信 / 云开发 API 的用法，**先根据已有代码和 `project.config.json` / 云函数代码推断**，再补充必要解释。
- 能公用的逻辑尽量提取到 `utils/`、`services/` 等目录，避免在页面和云函数之间复制粘贴同样的代码。

## 小程序前端规则
@match */miniprogram/* 
@match miniprogram/*
@match */client/*
@match pages/**
@match components/**

- 只使用 **微信小程序原生语法**（`wxml`、`wxss`、`js`、`json`），**不要引入 React、Vue、jQuery 等框架**，除非项目中已经在用。
- 小程序页面结构：
  - 页面文件组合：`index.wxml` + `index.wxss` + `index.js` + `index.json`
  - 组件文件组合：`xxx.wxml` + `xxx.wxss` + `xxx.js` + `xxx.json`
- 事件绑定使用 `bindtap`、`bindinput` 等微信原生事件，**不要写成 `onClick` 这类 Web 写法**。
- 使用 `this.setData` 更新页面数据，避免直接修改 `this.data`。
- 网络请求：
  - 如使用云函数，优先通过 `wx.cloud.callFunction` 调用后端逻辑。
  - 如必须直连 HTTP API，使用 `wx.request`，并做好错误处理和加载状态。
- 尽量把业务请求封装成统一的 service，例如：
  - `miniprogram/services/user.js`
  - `miniprogram/services/order.js`
- UI 逻辑与业务逻辑拆分：
  - 页面 `onLoad/onShow` 只做数据获取和调用 service。
  - 复杂数据处理放到 `utils/` 或 `services/`。


## 云开发初始化规则（前端）
@match app.js
@match app.ts

- 在 `App` 启动时初始化云开发，例如：

```js
App({
  onLaunch() {
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    } else {
      wx.cloud.init({
        env: 'your-env-id',
        traceUser: true,
      });
    }
  },
});

在其他页面、组件里不要重复调用 wx.cloud.init，只需要直接使用 wx.cloud.callFunction 等 API。

## 云函数规则
@match cloudfunctions
@match functions

云函数使用 Node.js + CommonJS 规范：

使用 const cloud = require('wx-server-sdk')

导出入口为 exports.main = async (event, context) => { ... }

云函数顶部必须初始化云开发（如果项目已有公共初始化封装，按项目现有方式来）：

```js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV,
});
const db = cloud.database();
访问数据库时使用 db.collection('xxx')，并使用异步写法：

```js
const res = await db.collection('users').where({ openid }).get();
云函数要做好：

入参校验（例如判断必填字段、类型）

错误捕获：使用 try/catch，并返回带有 code 和 message 的统一结构

日志记录：使用 console.log 打关键日志，便于在云开发控制台排查问题

返回数据建议统一为：

``` js
return {
  code: 0,          // 0 表示成功，非 0 表示错误
  message: 'ok',
  data,             // 业务数据
};
```js
## 云数据库 & 安全规则

使用云数据库时：

注意 where 条件，避免全表扫描（例如必须加 openid、status 等过滤条件）。

大数据查询要分页，使用 skip + limit。

不要在前端暴露敏感逻辑：

与权限、角色、支付、订单相关的关键校验必须放在云函数中完成。

前端不直接写任何数据库读写逻辑（除非是简单公开数据）。

对用户身份：

优先通过 cloud.getWXContext() 获取 OPENID，不从前端传 openid 进来。

不要信任前端传入的用户标识，要在云函数侧重新获取和验证。

# 目录结构建议（若需要新增文件）


## 小程序端常见目录：

miniprogram/
  ├─ app.js / app.json / app.wxss
  ├─ pages/
  │   ├─ index/
  │   ├─ mine/
  ├─ components/
  ├─ services/    # 封装接口调用、业务服务
  ├─ utils/       # 工具函数
  └─ config/      # 常量配置

## 云函数目录：

cloudfunctions/
  ├─ login/
  │   ├─ index.js
  │   └─ package.json
  ├─ user/
  └─ order/

新增代码时，优先按上述结构放置，不要在根目录随意建文件。

# 代码质量与可维护性

新增页面 / 组件 / 云函数时，请同时：

写好必要注释，说明用途和调用方式。

保持函数短小，每个函数只做一件事。

对用户可见的错误信息要友好，避免把内部错误直接暴露给用户。

如已有 ESLint / Prettier / 小程序构建配置，遵从现有配置，不要随意改动。

如需要引入第三方依赖：

前端小程序需确认在小程序运行环境可用。

云函数依赖需要写入对应 cloudfunctions/**/package.json 中。

当你不确定时怎么做:

先根据当前项目的文件结构、已有示例页面/云函数推断写法。

尽量复用已有工具方法、service 模块。

写完代码后，顺带给出简短的使用说明